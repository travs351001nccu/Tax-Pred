<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tax Prediction Project - 程式碼說明文件</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="full_code_review_files/libs/clipboard/clipboard.min.js"></script>
<script src="full_code_review_files/libs/quarto-html/quarto.js"></script>
<script src="full_code_review_files/libs/quarto-html/popper.min.js"></script>
<script src="full_code_review_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="full_code_review_files/libs/quarto-html/anchor.min.js"></script>
<link href="full_code_review_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="full_code_review_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="full_code_review_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="full_code_review_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="full_code_review_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup.r-說明文件" id="toc-setup.r-說明文件" class="nav-link active" data-scroll-target="#setup.r-說明文件">0_setup.R 說明文件</a>
  <ul class="collapse">
  <li><a href="#套件與基本路徑設定" id="toc-套件與基本路徑設定" class="nav-link" data-scroll-target="#套件與基本路徑設定">0.1. 套件與基本路徑設定</a></li>
  <li><a href="#參數與檔案路徑設定" id="toc-參數與檔案路徑設定" class="nav-link" data-scroll-target="#參數與檔案路徑設定">0.2. 參數與檔案路徑設定</a></li>
  <li><a href="#建立-h-專屬輸出資料夾" id="toc-建立-h-專屬輸出資料夾" class="nav-link" data-scroll-target="#建立-h-專屬輸出資料夾">0.3. 建立 h 專屬輸出資料夾</a></li>
  <li><a href="#讀取原始資料並標準化欄位名稱" id="toc-讀取原始資料並標準化欄位名稱" class="nav-link" data-scroll-target="#讀取原始資料並標準化欄位名稱">0.4. 讀取原始資料並標準化欄位名稱</a></li>
  <li><a href="#解析時間欄位-yyyy-mm-格式" id="toc-解析時間欄位-yyyy-mm-格式" class="nav-link" data-scroll-target="#解析時間欄位-yyyy-mm-格式">0.5. 解析時間欄位 (YYYY-Mm 格式)</a></li>
  <li><a href="#目標變數轉為-yoy-成長率" id="toc-目標變數轉為-yoy-成長率" class="nav-link" data-scroll-target="#目標變數轉為-yoy-成長率">0.6. 目標變數轉為 YoY 成長率</a></li>
  <li><a href="#根據-tcode-轉換變數" id="toc-根據-tcode-轉換變數" class="nav-link" data-scroll-target="#根據-tcode-轉換變數">0.7. 根據 tcode 轉換變數</a></li>
  <li><a href="#pca-因子計算" id="toc-pca-因子計算" class="nav-link" data-scroll-target="#pca-因子計算">0.8. PCA 因子計算</a></li>
  <li><a href="#建立-lag-特徵" id="toc-建立-lag-特徵" class="nav-link" data-scroll-target="#建立-lag-特徵">0.9. 建立 lag 特徵</a></li>
  <li><a href="#儲存處理後的資料" id="toc-儲存處理後的資料" class="nav-link" data-scroll-target="#儲存處理後的資料">0.10. 儲存處理後的資料</a></li>
  <li><a href="#小結" id="toc-小結" class="nav-link" data-scroll-target="#小結">0.小結</a></li>
  </ul></li>
  <li><a href="#models_ts.r-說明文件" id="toc-models_ts.r-說明文件" class="nav-link" data-scroll-target="#models_ts.r-說明文件">1_models_ts.R 說明文件</a>
  <ul class="collapse">
  <li><a href="#載入準備好的資料與檢查環境設定" id="toc-載入準備好的資料與檢查環境設定" class="nav-link" data-scroll-target="#載入準備好的資料與檢查環境設定">1.1. 載入準備好的資料與檢查環境設定</a></li>
  <li><a href="#定義誤差評估指標函數" id="toc-定義誤差評估指標函數" class="nav-link" data-scroll-target="#定義誤差評估指標函數">1.2. 定義誤差評估指標函數</a></li>
  <li><a href="#建立-rolling-預測的索引與進度條" id="toc-建立-rolling-預測的索引與進度條" class="nav-link" data-scroll-target="#建立-rolling-預測的索引與進度條">1.3. 建立 Rolling 預測的索引與進度條</a></li>
  <li><a href="#主要-rolling-預測迴圈與三種時間序列模型" id="toc-主要-rolling-預測迴圈與三種時間序列模型" class="nav-link" data-scroll-target="#主要-rolling-預測迴圈與三種時間序列模型">1.4. 主要 Rolling 預測迴圈與三種時間序列模型</a></li>
  <li><a href="#彙整所有-rolling-結果並計算誤差指標" id="toc-彙整所有-rolling-結果並計算誤差指標" class="nav-link" data-scroll-target="#彙整所有-rolling-結果並計算誤差指標">1.5. 彙整所有 Rolling 結果並計算誤差指標</a></li>
  <li><a href="#儲存結果到-.rds-檔案" id="toc-儲存結果到-.rds-檔案" class="nav-link" data-scroll-target="#儲存結果到-.rds-檔案">1.6. 儲存結果到 .rds 檔案</a></li>
  </ul></li>
  <li><a href="#models_lasso.r---lasso-家族-lasso-ridge-elastic-net-adaptive-pcr" id="toc-models_lasso.r---lasso-家族-lasso-ridge-elastic-net-adaptive-pcr" class="nav-link" data-scroll-target="#models_lasso.r---lasso-家族-lasso-ridge-elastic-net-adaptive-pcr">2_models_lasso.R - Lasso 家族 (Lasso / Ridge / Elastic Net / Adaptive / PCR)</a>
  <ul class="collapse">
  <li><a href="#套件載入" id="toc-套件載入" class="nav-link" data-scroll-target="#套件載入">2.1. 套件載入</a></li>
  <li><a href="#載入資料與設定" id="toc-載入資料與設定" class="nav-link" data-scroll-target="#載入資料與設定">2.2. 載入資料與設定</a></li>
  <li><a href="#定義誤差衡量函數" id="toc-定義誤差衡量函數" class="nav-link" data-scroll-target="#定義誤差衡量函數">2.3. 定義誤差衡量函數</a></li>
  <li><a href="#設定-glmnet-共同參數" id="toc-設定-glmnet-共同參數" class="nav-link" data-scroll-target="#設定-glmnet-共同參數">2.4. 設定 glmnet 共同參數</a></li>
  <li><a href="#rolling-預測架構" id="toc-rolling-預測架構" class="nav-link" data-scroll-target="#rolling-預測架構">2.5. Rolling 預測架構</a></li>
  <li><a href="#主迴圈模型訓練與預測" id="toc-主迴圈模型訓練與預測" class="nav-link" data-scroll-target="#主迴圈模型訓練與預測">2.6. 主迴圈：模型訓練與預測</a></li>
  <li><a href="#彙整結果與評估指標" id="toc-彙整結果與評估指標" class="nav-link" data-scroll-target="#彙整結果與評估指標">2.7. 彙整結果與評估指標</a></li>
  <li><a href="#儲存結果" id="toc-儲存結果" class="nav-link" data-scroll-target="#儲存結果">2.8. 儲存結果</a></li>
  </ul></li>
  <li><a href="#models_ml.r-說明文件" id="toc-models_ml.r-說明文件" class="nav-link" data-scroll-target="#models_ml.r-說明文件">3_models_ml.R 說明文件</a>
  <ul class="collapse">
  <li><a href="#套件載入與腳本說明" id="toc-套件載入與腳本說明" class="nav-link" data-scroll-target="#套件載入與腳本說明">3.1. 套件載入與腳本說明</a></li>
  <li><a href="#載入準備好的資料與基本設定" id="toc-載入準備好的資料與基本設定" class="nav-link" data-scroll-target="#載入準備好的資料與基本設定">3.2. 載入準備好的資料與基本設定</a></li>
  <li><a href="#定義預測誤差指標函數" id="toc-定義預測誤差指標函數" class="nav-link" data-scroll-target="#定義預測誤差指標函數">3.3. 定義預測誤差指標函數</a></li>
  <li><a href="#建立-rolling-預測索引與進度條" id="toc-建立-rolling-預測索引與進度條" class="nav-link" data-scroll-target="#建立-rolling-預測索引與進度條">3.4. 建立 Rolling 預測索引與進度條</a></li>
  <li><a href="#rolling-迴圈建模與預測bagging-random-forest" id="toc-rolling-迴圈建模與預測bagging-random-forest" class="nav-link" data-scroll-target="#rolling-迴圈建模與預測bagging-random-forest">3.5. Rolling 迴圈：建模與預測（Bagging / Random Forest）</a></li>
  <li><a href="#彙整所有-rolling-結果並計算誤差指標-1" id="toc-彙整所有-rolling-結果並計算誤差指標-1" class="nav-link" data-scroll-target="#彙整所有-rolling-結果並計算誤差指標-1">3.6. 彙整所有 Rolling 結果並計算誤差指標</a></li>
  <li><a href="#儲存結果到-.rds-檔" id="toc-儲存結果到-.rds-檔" class="nav-link" data-scroll-target="#儲存結果到-.rds-檔">3.7. 儲存結果到 .rds 檔</a></li>
  </ul></li>
  <li><a href="#combine_results.r---合併所有模型結果並輸出" id="toc-combine_results.r---合併所有模型結果並輸出" class="nav-link" data-scroll-target="#combine_results.r---合併所有模型結果並輸出">4_combine_results.R - 合併所有模型結果並輸出</a>
  <ul class="collapse">
  <li><a href="#套件載入-1" id="toc-套件載入-1" class="nav-link" data-scroll-target="#套件載入-1">4.1. 套件載入</a></li>
  <li><a href="#載入所有結果" id="toc-載入所有結果" class="nav-link" data-scroll-target="#載入所有結果">4.2. 載入所有結果</a></li>
  <li><a href="#檔案檢查與讀取" id="toc-檔案檢查與讀取" class="nav-link" data-scroll-target="#檔案檢查與讀取">4.3. 檔案檢查與讀取</a></li>
  <li><a href="#載入與整合結果" id="toc-載入與整合結果" class="nav-link" data-scroll-target="#載入與整合結果">4.4. 載入與整合結果</a></li>
  <li><a href="#合併所有預測與評分結果" id="toc-合併所有預測與評分結果" class="nav-link" data-scroll-target="#合併所有預測與評分結果">4.5. 合併所有預測與評分結果</a></li>
  <li><a href="#輸出結果到-excel" id="toc-輸出結果到-excel" class="nav-link" data-scroll-target="#輸出結果到-excel">4.6. 輸出結果到 Excel</a></li>
  <li><a href="#寫出多個-excel-檔案" id="toc-寫出多個-excel-檔案" class="nav-link" data-scroll-target="#寫出多個-excel-檔案">4.7. 寫出多個 Excel 檔案</a></li>
  <li><a href="#完成訊息" id="toc-完成訊息" class="nav-link" data-scroll-target="#完成訊息">4.8. 完成訊息</a></li>
  <li><a href="#小結-1" id="toc-小結-1" class="nav-link" data-scroll-target="#小結-1">4.小結</a></li>
  </ul></li>
  <li><a href="#nowcast.r---未來多期預測nowcast" id="toc-nowcast.r---未來多期預測nowcast" class="nav-link" data-scroll-target="#nowcast.r---未來多期預測nowcast">5_nowcast.R - 未來多期預測（Nowcast）</a>
  <ul class="collapse">
  <li><a href="#套件載入-2" id="toc-套件載入-2" class="nav-link" data-scroll-target="#套件載入-2">5.1. 套件載入</a></li>
  <li><a href="#載入資料與設定-1" id="toc-載入資料與設定-1" class="nav-link" data-scroll-target="#載入資料與設定-1">5.2. 載入資料與設定</a></li>
  <li><a href="#預測設定與-glmnet-參數" id="toc-預測設定與-glmnet-參數" class="nav-link" data-scroll-target="#預測設定與-glmnet-參數">5.3. 預測設定與 glmnet 參數</a></li>
  <li><a href="#準備最後一個訓練窗" id="toc-準備最後一個訓練窗" class="nav-link" data-scroll-target="#準備最後一個訓練窗">5.4. 準備最後一個訓練窗</a></li>
  <li><a href="#建立訓練資料與預測基準" id="toc-建立訓練資料與預測基準" class="nav-link" data-scroll-target="#建立訓練資料與預測基準">5.5. 建立訓練資料與預測基準</a></li>
  <li><a href="#a-時間序列模型預測" id="toc-a-時間序列模型預測" class="nav-link" data-scroll-target="#a-時間序列模型預測">5.6. (A) 時間序列模型預測</a></li>
  <li><a href="#b-lasso-家族與-pcrdirect-strategy" id="toc-b-lasso-家族與-pcrdirect-strategy" class="nav-link" data-scroll-target="#b-lasso-家族與-pcrdirect-strategy">5.7. (B) Lasso 家族與 PCR（Direct Strategy）</a></li>
  <li><a href="#c-非線性模型bagging-tree-與-random-forest" id="toc-c-非線性模型bagging-tree-與-random-forest" class="nav-link" data-scroll-target="#c-非線性模型bagging-tree-與-random-forest">5.8. (C) 非線性模型：Bagging Tree 與 Random Forest</a></li>
  <li><a href="#d-整併所有結果" id="toc-d-整併所有結果" class="nav-link" data-scroll-target="#d-整併所有結果">5.9. (D) 整併所有結果</a></li>
  <li><a href="#e-將-yoy-預測轉回實際稅收值" id="toc-e-將-yoy-預測轉回實際稅收值" class="nav-link" data-scroll-target="#e-將-yoy-預測轉回實際稅收值">5.10. (E) 將 YoY 預測轉回實際稅收值</a></li>
  <li><a href="#f-輸出結果" id="toc-f-輸出結果" class="nav-link" data-scroll-target="#f-輸出結果">5.11. (F) 輸出結果</a></li>
  <li><a href="#結束訊息" id="toc-結束訊息" class="nav-link" data-scroll-target="#結束訊息">5.12. 結束訊息</a></li>
  <li><a href="#小結-2" id="toc-小結-2" class="nav-link" data-scroll-target="#小結-2">5.小結</a></li>
  </ul></li>
  <li><a href="#variable_importance.r---計算變數重要性" id="toc-variable_importance.r---計算變數重要性" class="nav-link" data-scroll-target="#variable_importance.r---計算變數重要性">6_variable_importance.R - 計算變數重要性</a>
  <ul class="collapse">
  <li><a href="#套件載入與資料準備" id="toc-套件載入與資料準備" class="nav-link" data-scroll-target="#套件載入與資料準備">6.1. 套件載入與資料準備</a></li>
  <li><a href="#讀取訓練資料與設定" id="toc-讀取訓練資料與設定" class="nav-link" data-scroll-target="#讀取訓練資料與設定">6.2. 讀取訓練資料與設定</a></li>
  <li><a href="#參數與輔助函數" id="toc-參數與輔助函數" class="nav-link" data-scroll-target="#參數與輔助函數">6.3. 參數與輔助函數</a></li>
  <li><a href="#建立訓練資料direct-strategy" id="toc-建立訓練資料direct-strategy" class="nav-link" data-scroll-target="#建立訓練資料direct-strategy">6.4. 建立訓練資料（Direct Strategy）</a></li>
  <li><a href="#a-lasso-家族重要性以-β-為準" id="toc-a-lasso-家族重要性以-β-為準" class="nav-link" data-scroll-target="#a-lasso-家族重要性以-β-為準">6.5. (A) Lasso 家族重要性（以 |β| 為準）</a></li>
  <li><a href="#b-pcr-重要性loading-β-加權和" id="toc-b-pcr-重要性loading-β-加權和" class="nav-link" data-scroll-target="#b-pcr-重要性loading-β-加權和">6.6. (B) PCR 重要性（loading × β 加權和）</a></li>
  <li><a href="#c-樹模型重要性" id="toc-c-樹模型重要性" class="nav-link" data-scroll-target="#c-樹模型重要性">6.7. (C) 樹模型重要性</a></li>
  <li><a href="#d-lag-層級排名表" id="toc-d-lag-層級排名表" class="nav-link" data-scroll-target="#d-lag-層級排名表">6.8. (D) LAG 層級排名表</a></li>
  <li><a href="#e-名稱對照表映射" id="toc-e-名稱對照表映射" class="nav-link" data-scroll-target="#e-名稱對照表映射">6.9. (E) 名稱對照表映射</a></li>
  <li><a href="#f-base-層級彙總" id="toc-f-base-層級彙總" class="nav-link" data-scroll-target="#f-base-層級彙總">6.10. (F) BASE 層級彙總</a></li>
  <li><a href="#g-結果輸出" id="toc-g-結果輸出" class="nav-link" data-scroll-target="#g-結果輸出">6.11. (G) 結果輸出</a></li>
  <li><a href="#結束訊息與預覽" id="toc-結束訊息與預覽" class="nav-link" data-scroll-target="#結束訊息與預覽">6.12. 結束訊息與預覽</a></li>
  <li><a href="#小結-3" id="toc-小結-3" class="nav-link" data-scroll-target="#小結-3">6.小結</a></li>
  </ul></li>
  <li><a href="#visualize.r-視覺化分析" id="toc-visualize.r-視覺化分析" class="nav-link" data-scroll-target="#visualize.r-視覺化分析">7_visualize.R — 視覺化分析</a>
  <ul class="collapse">
  <li><a href="#套件載入與輸出結構設定" id="toc-套件載入與輸出結構設定" class="nav-link" data-scroll-target="#套件載入與輸出結構設定">7.1. 套件載入與輸出結構設定</a></li>
  <li><a href="#樣本外預測資料載入與繪圖" id="toc-樣本外預測資料載入與繪圖" class="nav-link" data-scroll-target="#樣本外預測資料載入與繪圖">7.2. 樣本外預測資料載入與繪圖</a>
  <ul class="collapse">
  <li><a href="#圖-1-時間序列模型" id="toc-圖-1-時間序列模型" class="nav-link" data-scroll-target="#圖-1-時間序列模型">7.2.1 圖 1 – 時間序列模型</a></li>
  <li><a href="#圖-2-lasso-家族模型" id="toc-圖-2-lasso-家族模型" class="nav-link" data-scroll-target="#圖-2-lasso-家族模型">7.2.2 圖 2 – Lasso 家族模型</a></li>
  <li><a href="#圖-3-機器學習模型" id="toc-圖-3-機器學習模型" class="nav-link" data-scroll-target="#圖-3-機器學習模型">7.2.3 圖 3 – 機器學習模型</a></li>
  <li><a href="#圖-4-各模型誤差分布" id="toc-圖-4-各模型誤差分布" class="nav-link" data-scroll-target="#圖-4-各模型誤差分布">7.2.4 圖 4 – 各模型誤差分布</a></li>
  <li><a href="#圖-5-rmse-模型排名" id="toc-圖-5-rmse-模型排名" class="nav-link" data-scroll-target="#圖-5-rmse-模型排名">7.2.5 圖 5 – RMSE 模型排名</a></li>
  </ul></li>
  <li><a href="#未來預測-nowcast" id="toc-未來預測-nowcast" class="nav-link" data-scroll-target="#未來預測-nowcast">7.3. 未來預測 (Nowcast)</a>
  <ul class="collapse">
  <li><a href="#資料載入" id="toc-資料載入" class="nav-link" data-scroll-target="#資料載入">7.3.1 資料載入</a></li>
  <li><a href="#圖-6-未來-yoy-預測路徑" id="toc-圖-6-未來-yoy-預測路徑" class="nav-link" data-scroll-target="#圖-6-未來-yoy-預測路徑">7.3.2 圖 6 – 未來 YoY 預測路徑</a></li>
  <li><a href="#圖-7-實際稅收預測" id="toc-圖-7-實際稅收預測" class="nav-link" data-scroll-target="#圖-7-實際稅收預測">7.3.3 圖 7 – 實際稅收預測</a></li>
  </ul></li>
  <li><a href="#變數重要性分析" id="toc-變數重要性分析" class="nav-link" data-scroll-target="#變數重要性分析">7.4. 變數重要性分析</a>
  <ul class="collapse">
  <li><a href="#載入與轉換" id="toc-載入與轉換" class="nav-link" data-scroll-target="#載入與轉換">7.4.1 載入與轉換</a></li>
  <li><a href="#圖-8-各模型前五名變數" id="toc-圖-8-各模型前五名變數" class="nav-link" data-scroll-target="#圖-8-各模型前五名變數">7.4.2 圖 8 – 各模型前五名變數</a></li>
  <li><a href="#圖-9-共識熱力圖" id="toc-圖-9-共識熱力圖" class="nav-link" data-scroll-target="#圖-9-共識熱力圖">7.4.3 圖 9 – 共識熱力圖</a></li>
  </ul></li>
  <li><a href="#收尾與輸出檢查" id="toc-收尾與輸出檢查" class="nav-link" data-scroll-target="#收尾與輸出檢查">7.5. 收尾與輸出檢查</a></li>
  <li><a href="#總結" id="toc-總結" class="nav-link" data-scroll-target="#總結">7.總結</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tax Prediction Project - 程式碼說明文件</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="setup.r-說明文件" class="level1">
<h1>0_setup.R 說明文件</h1>
<p>這份文件用來解釋 <code>0_setup.R</code> 在專案裡的角色與執行邏輯。<br>
主要步驟包含：</p>
<ol type="1">
<li>套件載入與安裝<br>
</li>
<li>路徑與參數設定<br>
</li>
<li>輸出目錄建立<br>
</li>
<li>讀檔與時間轉換<br>
</li>
<li>目標變數 YoY 化<br>
</li>
<li>依 tcode 轉換變數<br>
</li>
<li>PCA 因子計算<br>
</li>
<li>建立 lag 特徵<br>
</li>
<li>儲存結果</li>
</ol>
<p>讀者可以把這份文件當成「這個專案前處理程式碼的操作說明書」。</p>
<hr>
<section id="套件與基本路徑設定" class="level2">
<h2 class="anchored" data-anchor-id="套件與基本路徑設定">0.1. 套件與基本路徑設定</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"data.table"</span>,<span class="st">"readxl"</span>,<span class="st">"lubridate"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>ins <span class="ot">&lt;-</span> pkgs[<span class="sc">!</span>pkgs <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[,<span class="st">"Package"</span>]]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(ins)) <span class="fu">install.packages</span>(ins, <span class="at">repos=</span><span class="st">"https://cloud.r-project.org"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, library, <span class="at">character.only=</span><span class="cn">TRUE</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>local_path <span class="ot">&lt;-</span> <span class="fu">getwd</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>pkgs</code>：列出這支程式會用到的套件。
<ul>
<li><code>data.table</code>：加速資料處理，用中括號 <code>[]</code> 搭配特殊語法。<br>
</li>
<li><code>readxl</code>：用來讀取 Excel 檔。<br>
</li>
<li><code>lubridate</code>：處理日期用，這裡後面雖然沒有直接呼叫，但保留以防之後要用。<br>
</li>
</ul></li>
<li><code>installed.packages()</code>：回傳目前電腦已安裝的套件。
<ul>
<li><code>pkgs[!pkgs %in% installed.packages()[,"Package"]]</code>：找出還沒安裝的套件名稱。<br>
</li>
</ul></li>
<li><code>install.packages(ins, ...)</code>：如果有缺的套件就從 CRAN 安裝。<br>
</li>
<li><code>lapply(pkgs, library, character.only=TRUE)</code>：把 <code>pkgs</code> 裡的每一個套件都 <code>library()</code> 一次。
<ul>
<li>外面包 <code>invisible()</code> 是為了不要顯示多餘訊息。<br>
</li>
</ul></li>
<li><code>getwd()</code>：取得目前工作目錄，存到 <code>local_path</code>，之後組檔案路徑都用這個當根。</li>
</ul>
<hr>
</section>
<section id="參數與檔案路徑設定" class="level2">
<h2 class="anchored" data-anchor-id="參數與檔案路徑設定">0.2. 參數與檔案路徑設定</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>excel_path    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(local_path, <span class="st">"data"</span>, <span class="st">"wide_tab.xlsx"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sheet_name    <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>time_col      <span class="ot">&lt;-</span> <span class="st">"ym"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>target_col    <span class="ot">&lt;-</span> <span class="st">"A100101010_1"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"&gt;&gt;&gt; 現在的 h ="</span>, h, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>train_len     <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>p_max         <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>var_exp_cut   <span class="ot">&lt;-</span> <span class="fl">0.95</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>elastic_alpha <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>adapt_gamma   <span class="ot">&lt;-</span> <span class="fl">1.0</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>meta_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(local_path, <span class="st">"data"</span>, <span class="st">"meta_tab.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>file.path()</code>：用來組出不同作業系統都安全的路徑。
<ul>
<li>這裡把 <code>local_path</code> 加上 <code>data/wide_tab.xlsx</code>，得到主要資料檔的位置。<br>
</li>
<li><code>meta_path</code> 則是 meta 資料（裡面有 tcode 設定）的路徑。<br>
</li>
</ul></li>
<li><code>time_col</code>：時間欄位名稱，之後會用這個字串去抓對應欄位。<br>
</li>
<li><code>target_col</code>：要預測的目標變數欄位名稱。<br>
</li>
<li><code>exists("h")</code>：檢查環境裡有沒有已經設定好的 <code>h</code>。
<ul>
<li>如果外部沒事先指定，就預設 <code>h &lt;- 1</code>。<br>
</li>
</ul></li>
<li><code>cat()</code>：簡單印出目前的 <code>h</code> 值，用來確認有沒有設錯。<br>
</li>
<li><code>train_len</code>：每次 rolling 預測時，用多少期資料當訓練集。<br>
</li>
<li><code>p_max</code>：lag 特徵要做到第幾期（1 到 p_max）。<br>
</li>
<li><code>var_exp_cut</code>、<code>elastic_alpha</code>、<code>adapt_gamma</code>：後面 PCA 和 Elastic Net 相關模型會用到的參數，這裡先集中設定。</li>
</ul>
<hr>
</section>
<section id="建立-h-專屬輸出資料夾" class="level2">
<h2 class="anchored" data-anchor-id="建立-h-專屬輸出資料夾">0.3. 建立 h 專屬輸出資料夾</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> <span class="fu">file.path</span>(local_path, <span class="st">"outputs"</span>, <span class="fu">sprintf</span>(<span class="st">"h_%d"</span>, h))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(output_root, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_root, <span class="st">"results"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(results_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">=== 輸出目錄設定 ===</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"h = %d</span><span class="sc">\n</span><span class="st">"</span>, h))</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"輸出根目錄: %s</span><span class="sc">\n\n</span><span class="st">"</span>, output_root))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>sprintf("h_%d", h)</code>：把目前的 <code>h</code> 拼成字串，例如 <code>h_1</code>、<code>h_2</code>。<br>
</li>
<li><code>output_root</code>：這次預測（指定的 h）所有輸出檔案的根目錄。<br>
</li>
<li><code>dir.create(..., recursive=TRUE)</code>：如果中間資料夾不存在就一路建立。<br>
</li>
<li><code>results_dir</code>：專門拿來放處理好資料、模型結果等的子資料夾。<br>
</li>
<li>這一段的重點是：每一個 <code>h</code> 都會有自己的輸出路徑，避免不同預測期的結果互相覆蓋。</li>
</ul>
<hr>
</section>
<section id="讀取原始資料並標準化欄位名稱" class="level2">
<h2 class="anchored" data-anchor-id="讀取原始資料並標準化欄位名稱">0.4. 讀取原始資料並標準化欄位名稱</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>raw <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(readxl<span class="sc">::</span><span class="fu">read_excel</span>(excel_path, <span class="at">sheet =</span> sheet_name))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(raw, <span class="at">old=</span><span class="fu">names</span>(raw), <span class="at">new=</span><span class="fu">make.names</span>(<span class="fu">names</span>(raw)))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>time_col   <span class="ot">&lt;-</span> <span class="fu">make.names</span>(time_col)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> <span class="fu">make.names</span>(target_col)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(time_col <span class="sc">%in%</span> <span class="fu">names</span>(raw), target_col <span class="sc">%in%</span> <span class="fu">names</span>(raw))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>readxl::read_excel()</code>：從 Excel 檔讀進一個 data.frame。<br>
</li>
<li><code>as.data.table()</code>：轉成 data.table 物件，之後可以用 data.table 語法。<br>
</li>
<li><code>setnames()</code>：一次改變所有欄位名稱。
<ul>
<li><code>make.names()</code>：把欄位名稱轉成 R 合法的名稱（把空白、特殊字元改掉）。<br>
</li>
</ul></li>
<li><code>time_col &lt;- make.names(time_col)</code>：讓時間欄名稱也套用同樣規則，之後才對得起來。<br>
</li>
<li><code>stopifnot()</code>：檢查時間欄和目標變數欄是不是都存在於 <code>raw</code>，如果不存在會直接報錯停止。</li>
</ul>
<hr>
</section>
<section id="解析時間欄位-yyyy-mm-格式" class="level2">
<h2 class="anchored" data-anchor-id="解析時間欄位-yyyy-mm-格式">0.5. 解析時間欄位 (YYYY-Mm 格式)</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>parse_ym_M <span class="ot">&lt;-</span> <span class="cf">function</span>(v){</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  v  <span class="ot">&lt;-</span> <span class="fu">as.character</span>(v)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  yr <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sub</span>(<span class="st">"^(</span><span class="sc">\\</span><span class="st">d{4})-M.*$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, v))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  mm <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">sub</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d{4}-M(</span><span class="sc">\\</span><span class="st">d{1,2})$"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, v))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(yr)) <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(mm))) {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"時間欄位必須長得像 '2025-M1' 或 '2025-M11'"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.Date</span>(<span class="fu">sprintf</span>(<span class="st">"%04d-%02d-01"</span>, yr, mm))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>raw[, (time_col) <span class="sc">:</span><span class="er">=</span> <span class="fu">parse_ym_M</span>(<span class="fu">get</span>(time_col))]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">setorderv</span>(raw, <span class="at">cols =</span> time_col, <span class="at">order =</span> <span class="dv">1</span>L, <span class="at">na.last =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>這段的目標是把像 <code>2025-M1</code> 這種格式轉成真正的日期。<br>
</li>
<li><code>sub("^(\\d{4})-M.*$", "\\1", v)</code>：用正規表示式抓出前四碼的年份。<br>
</li>
<li><code>sub("^\\d{4}-M(\\d{1,2})$", "\\1", v)</code>：抓出 M 後面的月份數字。<br>
</li>
<li>如果年份或月份抓不出來，就 <code>stop()</code> 給警告。<br>
</li>
<li><code>as.Date(sprintf("%04d-%02d-01", yr, mm))</code>：把年與月組成「當月一號」的日期物件。<br>
</li>
<li><code>raw[, (time_col) := parse_ym_M(get(time_col))]</code>：
<ul>
<li><code>get(time_col)</code>：用欄位名稱字串抓出對應欄。<br>
</li>
<li><code>:=</code> 是 data.table 的「就地新增或覆寫欄位」語法。<br>
</li>
</ul></li>
<li><code>setorderv()</code>：依照時間欄位排序，確保資料的時間順序是由舊到新。</li>
</ul>
<hr>
</section>
<section id="目標變數轉為-yoy-成長率" class="level2">
<h2 class="anchored" data-anchor-id="目標變數轉為-yoy-成長率">0.6. 目標變數轉為 YoY 成長率</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>raw[, <span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">get</span>(target_col)]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>raw[, (target_col) <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  original <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  lag12 <span class="ot">&lt;-</span> <span class="fu">shift</span>(original, <span class="at">n=</span><span class="dv">12</span>, <span class="at">type=</span><span class="st">"lag"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  (original <span class="sc">-</span> lag12) <span class="sc">/</span> lag12</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>paste0(target_col, "_original")</code>：產生一個新的欄位名稱，存原始水準值。<br>
</li>
<li>第一行用 <code>:=</code> 在 <code>raw</code> 裡新增一個欄位，把原來的目標變數備份起來。<br>
</li>
<li><code>shift(original, n=12, type="lag")</code>：
<ul>
<li>來自 <code>data.table</code>，用來做落後值。<br>
</li>
<li>這裡是計算 12 期前的值，也就是去年同期。<br>
</li>
</ul></li>
<li><code>(original - lag12) / lag12</code>：算 YoY 成長率。<br>
</li>
<li>第二個 <code>raw[, (target_col) := {...}]</code>：
<ul>
<li>把原本的目標變數欄位覆寫為 YoY 成長率。<br>
</li>
<li>之後模型直接用這個成長率當目標。</li>
</ul></li>
</ul>
<hr>
</section>
<section id="根據-tcode-轉換變數" class="level2">
<h2 class="anchored" data-anchor-id="根據-tcode-轉換變數">0.7. 根據 tcode 轉換變數</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>meta_data <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(meta_path)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tcode_mapping <span class="ot">&lt;-</span> <span class="fu">setNames</span>(meta_data<span class="sc">$</span>tcode, meta_data<span class="sc">$</span>var_label)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>transform_variable <span class="ot">&lt;-</span> <span class="cf">function</span>(x, tcode) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">1</span>) <span class="fu">return</span>(x)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">2</span>) <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(x)))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(x))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(temp, <span class="at">na.rm=</span><span class="cn">FALSE</span>)))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">4</span>) <span class="fu">return</span>(<span class="fu">log</span>(x))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">5</span>) <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(x))))</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">6</span>) {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    temp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(x)))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(temp, <span class="at">na.rm=</span><span class="cn">FALSE</span>)))</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="cf">if</span>(tcode <span class="sc">==</span> <span class="dv">7</span>) {</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    pct <span class="ot">&lt;-</span> x <span class="sc">/</span> <span class="fu">c</span>(<span class="cn">NA</span>, x[<span class="sc">-</span><span class="fu">length</span>(x)]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(pct)))</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="fu">return</span>(x)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>transform_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(raw), <span class="fu">c</span>(time_col, target_col, <span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>)))</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(v <span class="cf">in</span> transform_vars) {</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  tcode <span class="ot">&lt;-</span> tcode_mapping[v]</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(tcode)) {</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    raw[[v]] <span class="ot">&lt;-</span> <span class="fu">transform_variable</span>(raw[[v]], tcode)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>meta_tab.xlsx</code> 裡面記錄每個變數的 <code>tcode</code>，代表要做什麼轉換，例如：
<ul>
<li>1：原始值不動。<br>
</li>
<li>2：一次差分。<br>
</li>
<li>4：取 log。<br>
</li>
<li>5：log 後再差分，等等。<br>
</li>
</ul></li>
<li><code>setNames(meta_data$tcode, meta_data$var_label)</code>：
<ul>
<li>建立一個「變數名稱 → tcode」的對照表。<br>
</li>
</ul></li>
<li><code>diff()</code>：計算相鄰觀測值的差。<br>
</li>
<li><code>log()</code>：自然對數。<br>
</li>
<li><code>x / c(NA, x[-length(x)]) - 1</code>：計算成長率（本期 / 前一期 − 1）。<br>
</li>
<li><code>transform_vars</code>：要做轉換的變數集合，排除時間欄、目標欄、目標原始欄。<br>
</li>
<li><code>raw[[v]] &lt;- transform_variable(raw[[v]], tcode)</code>：
<ul>
<li>用 list 取欄位的寫法，等同於 <code>raw[, v := ...]</code>，這裡寫法較直觀。<br>
</li>
</ul></li>
<li>這一段的目的，是把各變數轉成比較「平穩」的型態，減少趨勢或單根問題。</li>
</ul>
<hr>
</section>
<section id="pca-因子計算" class="level2">
<h2 class="anchored" data-anchor-id="pca-因子計算">0.8. PCA 因子計算</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>numeric_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(raw), <span class="fu">c</span>(time_col, target_col, <span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>)))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>numeric_data <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(raw[, ..numeric_vars])</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>complete_rows <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(numeric_data)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span> numeric_data[complete_rows, ]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>scaled_data <span class="ot">&lt;-</span> <span class="fu">scale</span>(clean_data)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>pca_result <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(scaled_data, <span class="at">center=</span><span class="cn">FALSE</span>, <span class="at">scale.=</span><span class="cn">FALSE</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>factors <span class="ot">&lt;-</span> pca_result<span class="sc">$</span>x[, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>factor_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow=</span><span class="fu">nrow</span>(raw), <span class="at">ncol=</span><span class="dv">4</span>))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(factor_df) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Factor"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>factor_df[complete_rows, ] <span class="ot">&lt;-</span> factors</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>raw <span class="ot">&lt;-</span> <span class="fu">cbind</span>(raw, factor_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>numeric_vars</code>：挑出要拿來做 PCA 的欄位，排除時間、目標與目標原始值。<br>
</li>
<li><code>raw[, ..numeric_vars]</code>：data.table 語法，選取多個欄位。前面的 <code>..</code> 是引用外部變數。<br>
</li>
<li><code>complete.cases()</code>：回傳哪些列沒有 NA。<br>
</li>
<li><code>clean_data</code>：只有完整列的資料，用來做 PCA。<br>
</li>
<li><code>scale(clean_data)</code>：把每個變數做標準化（減平均除標準差），避免變數尺度差太多。<br>
</li>
<li><code>prcomp()</code>：R 內建的主成分分析函數。
<ul>
<li>回傳的 <code>x</code> 是每一個樣本在各主成分上的分數。<br>
</li>
</ul></li>
<li><code>pca_result$x[, 1:4]</code>：取前四個主成分分數，當成共同因子。<br>
</li>
<li>為了讓原始資料筆數不變，用一個 <code>factor_df</code> 先填 NA，再把有完整資料的列放入因子分數。<br>
</li>
<li>最後 <code>cbind()</code> 把因子欄位接回 <code>raw</code>，多出 <code>Factor1</code> 到 <code>Factor4</code>。</li>
</ul>
<hr>
</section>
<section id="建立-lag-特徵" class="level2">
<h2 class="anchored" data-anchor-id="建立-lag-特徵">0.9. 建立 lag 特徵</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>num_vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(raw), <span class="fu">c</span>(time_col, <span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>)))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>make_lags <span class="ot">&lt;-</span> <span class="cf">function</span>(dt, vars, pmax){</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (v <span class="cf">in</span> vars){</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (L <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>pmax){</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      dt[, <span class="fu">paste0</span>(v,<span class="st">"_L"</span>,L) <span class="sc">:</span><span class="er">=</span> <span class="fu">shift</span>(<span class="fu">get</span>(v), <span class="at">n=</span>L, <span class="at">type=</span><span class="st">"lag"</span>)]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  dt</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">make_lags</span>(raw, <span class="at">vars=</span>num_vars, <span class="at">pmax=</span>p_max)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>lag_vars <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"(_L[0-9]+)$"</span>, <span class="fu">names</span>(dat), <span class="at">value=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>num_vars</code>：要做 lag 的變數集合，這裡排除時間欄和目標原始值，其餘全部建立 lag。<br>
</li>
<li><code>copy(dt)</code>：<code>data.table::copy</code>，避免在函數裡修改到原本的物件。<br>
</li>
<li>雙層迴圈邏輯：
<ul>
<li>外圈跑每一個變數 <code>v</code>。<br>
</li>
<li>內圈跑 <code>L = 1</code> 到 <code>pmax</code>，為每個變數建立第 1–pmax 期的落後值。<br>
</li>
</ul></li>
<li><code>shift(get(v), n=L, type="lag")</code>：
<ul>
<li>取變數 <code>v</code> 的第 L 期落後。<br>
</li>
<li>用 <code>paste0(v,"_L",L)</code> 當新欄位名稱，例如 <code>x_L1</code>。<br>
</li>
</ul></li>
<li><code>grep("(_L[0-9]+)$", names(dat), value=TRUE)</code>：抓出所有名字結尾長得像 <code>_L1</code>, <code>_L2</code>, … 的欄位，存成 <code>lag_vars</code>。
<ul>
<li>之後建模時，如果要「只用 lag 特徵」，可以直接用這個向量。</li>
</ul></li>
</ul>
<hr>
</section>
<section id="儲存處理後的資料" class="level2">
<h2 class="anchored" data-anchor-id="儲存處理後的資料">0.10. 儲存處理後的資料</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dat =</span> dat,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_col =</span> target_col,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_col_original =</span> <span class="fu">paste0</span>(target_col, <span class="st">"_original"</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_col =</span> time_col,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag_vars =</span> lag_vars,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">train_len =</span> train_len,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">h =</span> h,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">var_exp_cut =</span> var_exp_cut,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">elastic_alpha =</span> elastic_alpha,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">adapt_gamma =</span> adapt_gamma,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_root =</span> output_root,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">results_dir =</span> results_dir</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>), <span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>saveRDS()</code>：把一個 R 物件存成單一檔案。
<ul>
<li>這裡把所有需要的東西打包成一個 list：
<ul>
<li>前處理後的資料 <code>dat</code><br>
</li>
<li>目標欄名、時間欄名<br>
</li>
<li>lag 特徵名稱 <code>lag_vars</code><br>
</li>
<li>rolling 長度、h、以及一些模型相關參數<br>
</li>
<li>這次執行的輸出路徑<br>
</li>
</ul></li>
</ul></li>
<li>檔名固定是 <code>prepared_data.rds</code>，放在當前 h 的 <code>results_dir</code> 底下。<br>
</li>
<li>後續的模型腳本只需要 <code>readRDS()</code> 這個檔案，就能拿到一模一樣的資料與設定，不用再重跑前處理。</li>
</ul>
<hr>
</section>
<section id="小結" class="level2">
<h2 class="anchored" data-anchor-id="小結">0.小結</h2>
<p><code>0_setup.R</code> 的角色，是把原始的 Excel 資料轉成「可直接建模」的格式，並且把關鍵設定一起打包起來。</p>
<p>只要成功產生 <code>prepared_data.rds</code>，後面的程式就可以從同樣的起點開始做預測與評估，確保整個專案的流程是可重現、可維護的。</p>
</section>
</section>
<section id="models_ts.r-說明文件" class="level1">
<h1>1_models_ts.R 說明文件</h1>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ============================================================================</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 1_models_ts.R - 時間序列模型 (RandomWalk / AR / ARMA)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ============================================================================</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>腳本開頭的註解區塊
<ul>
<li>這三行 <code>## ===</code> 與中間那行文字只是「說明這支檔案用途」的註解，實際執行時不會對結果有任何影響。<br>
</li>
<li>這支檔案的功能是建立「時間序列模型」，包含 Random Walk、AR、ARMA 三種模型。</li>
</ul></li>
<li><code>library(data.table)</code>
<ul>
<li>功能：載入 <code>data.table</code> 套件。<br>
</li>
<li><code>data.table</code> 是一個加強版的 <code>data.frame</code>，適合處理大筆資料，提供更快的運算與簡潔的語法。<br>
</li>
<li>執行結果：載入後，就可以使用 <code>data.table()</code> 函數建立資料表，也可以用 <code>DT[ , .( ) , by= ]</code> 這種語法做群組計算。</li>
</ul></li>
<li><code>library(forecast)</code>
<ul>
<li>功能：載入 <code>forecast</code> 套件。<br>
</li>
<li><code>forecast</code> 提供時間序列分析與預測的常用工具，例如 <code>auto.arima()</code> 自動選 ARIMA 模型，<code>forecast()</code> 用來產生未來預測值。<br>
</li>
<li>執行結果：載入後，就可以使用 <code>forecast::auto.arima()</code>、<code>forecast::forecast()</code> 等函數來幫我們對時間序列做模型估計與預測。</li>
</ul></li>
</ol>
<section id="載入準備好的資料與檢查環境設定" class="level2">
<h2 class="anchored" data-anchor-id="載入準備好的資料與檢查環境設定">1.1. 載入準備好的資料與檢查環境設定</h2>
<p>這一節負責： 1. 印出提示訊息。 2. 檢查外部是否有設定 <code>h</code>。 3. 根據 <code>h</code> 找到對應的結果資料夾。 4. 從該資料夾讀取事先準備好的資料物件 <code>prepared_data.rds</code>。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 載入準備好的資料 ----</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"載入資料...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 用目前的 h 找資料夾（平行跑才不會亂）</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> setup<span class="sc">$</span>dat</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>time_col</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>train_len <span class="ot">&lt;-</span> setup<span class="sc">$</span>train_len</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> setup<span class="sc">$</span>output_root</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"使用 h = %d 的資料</span><span class="sc">\n</span><span class="st">"</span>, h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><code>cat("載入資料...\n")</code>
<ul>
<li>功能：在 R console 中印出文字訊息。<br>
</li>
<li><code>cat()</code> 會直接輸出字串，<code>\n</code> 代表換行。<br>
</li>
<li>執行結果：執行時會顯示<br>
<code>載入資料...</code><br>
讓使用者知道程式正在進行載入資料的動作。</li>
</ul></li>
<li><code>if (!exists("h")) stop("沒有設定 h，請在外面給 h 再跑這支 script。")</code>
<ul>
<li><code>exists("h")</code>
<ul>
<li>功能：檢查環境中是否已經存在名為 <code>h</code> 的物件。<br>
</li>
<li>執行結果：回傳 <code>TRUE</code> 或 <code>FALSE</code>。<br>
</li>
</ul></li>
<li><code>!exists("h")</code>
<ul>
<li>功能：邏輯「非」，如果 <code>h</code> 不存在就會是 <code>TRUE</code>。<br>
</li>
</ul></li>
<li><code>stop("...")</code>
<ul>
<li>功能：立刻中止程式，並顯示錯誤訊息。<br>
</li>
<li>執行結果：如果沒有預先設定 <code>h</code>，腳本會直接停止執行，避免後面步驟用到錯誤的資料。</li>
</ul></li>
</ul></li>
<li><code>results_dir &lt;- file.path("outputs", paste0("h_", h), "results")</code>
<ul>
<li><code>paste0("h_", h)</code>
<ul>
<li>功能：把字串 <code>"h_"</code> 和 <code>h</code> 的數值接在一起，例如 <code>h = 3</code> 時會變成 <code>"h_3"</code>。<br>
</li>
</ul></li>
<li><code>file.path(...)</code>
<ul>
<li>功能：依照作業系統自動組合路徑。例如在 Windows 會用 <code>\</code>，在 macOS/Linux 會用 <code>/</code>。<br>
</li>
</ul></li>
<li>執行結果：<code>results_dir</code> 會是一個像 <code>outputs/h_3/results</code> 的資料夾路徑，用來存放這個 <code>h</code> 對應的結果。</li>
</ul></li>
<li><code>if (!dir.exists(results_dir)) stop(...)</code>
<ul>
<li><code>dir.exists(results_dir)</code>
<ul>
<li>功能：檢查指定的資料夾是否存在。<br>
</li>
</ul></li>
<li>如果資料夾不存在，用 <code>stop()</code> 中止程式，並提示要先跑 <code>0_setup.R</code>。<br>
</li>
<li>執行結果：可以避免在資料還沒準備好時就進行建模。</li>
</ul></li>
<li><code>setup &lt;- readRDS(file.path(results_dir, "prepared_data.rds"))</code>
<ul>
<li><code>readRDS()</code>
<ul>
<li>功能：讀取 R 以 <code>.rds</code> 格式儲存的單一物件。<br>
</li>
<li><code>file.path(results_dir, "prepared_data.rds")</code> 則是組合出檔案路徑。<br>
</li>
</ul></li>
<li>執行結果：<code>setup</code> 會是一個 R 物件（通常是 list），裡面包含事先整理好的資料與設定。</li>
</ul></li>
<li><code>dat &lt;- setup$dat</code> 等一系列 <code>$</code> 取欄位的動作
<ul>
<li>功能：從 <code>setup</code> 這個 list 物件裡把各個元素取出來：
<ul>
<li><code>dat</code>：完整的時間序列資料表（通常是 <code>data.table</code> 或 <code>data.frame</code>）。<br>
</li>
<li><code>target_col</code>：目標變數（要預測的欄位）名稱（字串）。<br>
</li>
<li><code>time_col</code>：時間欄位名稱（字串）。<br>
</li>
<li><code>train_len</code>：每次 rolling 訓練集的長度（觀測值個數）。<br>
</li>
<li><code>h</code>：預測步數（forecast horizon），這裡又再用 <code>setup$h</code> 覆寫，確保跟準備資料時一致。<br>
</li>
<li><code>output_root</code>：輸出檔案的根目錄。<br>
</li>
</ul></li>
<li>執行結果：後面所有預測與儲存結果都會用這些物件。</li>
</ul></li>
<li><code>cat(sprintf("使用 h = %d 的資料\n", h))</code>
<ul>
<li><code>sprintf("使用 h = %d 的資料\n", h)</code>
<ul>
<li>功能：把 <code>h</code> 的數值帶入字串中的 <code>%d</code> 位置（整數格式）。<br>
</li>
</ul></li>
<li><code>cat(...)</code> 會把這個格式化後的字串印出來。<br>
</li>
<li>執行結果：例如 <code>h = 3</code> 時，console 會顯示<br>
<code>使用 h = 3 的資料</code><br>
幫助確認目前是在處理哪一個預測步數。</li>
</ul></li>
</ol>
</section>
<section id="定義誤差評估指標函數" class="level2">
<h2 class="anchored" data-anchor-id="定義誤差評估指標函數">1.2. 定義誤差評估指標函數</h2>
<p>這一節定義三個常用的預測誤差指標：RMSE、MAE、MAD。<br>
它們都是「函數」，後面會直接套用在誤差向量上。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 指標函數 ----</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">sqrt</span>(<span class="fu">mean</span>(e<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>mae  <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">mean</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>madm <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">median</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>自訂函數的基本形式
<ul>
<li><code>rmse &lt;- function(e) { ... }</code> 這種寫法是建立一個新函數，名稱叫 <code>rmse</code>，輸入參數是 <code>e</code>。<br>
</li>
<li>這裡使用的是「單行函數」寫法，省略 <code>{}</code>，R 會把右邊的運算結果當成回傳值。</li>
</ul></li>
<li><code>rmse &lt;- function(e) sqrt(mean(e^2, na.rm=TRUE))</code>
<ul>
<li>目標：計算 Root Mean Squared Error (RMSE)。<br>
</li>
<li><code>e^2</code>：把向量 <code>e</code> 中的每個值平方。<br>
</li>
<li><code>mean(..., na.rm=TRUE)</code>：計算平均值，<code>na.rm=TRUE</code> 代表忽略 <code>NA</code>。<br>
</li>
<li><code>sqrt(...)</code>：對平均平方誤差取平方根。<br>
</li>
<li>執行結果：<code>rmse(e)</code> 會回傳一個數值，代表這組誤差的 RMSE 大小。</li>
</ul></li>
<li><code>mae  &lt;- function(e) mean(abs(e), na.rm=TRUE)</code>
<ul>
<li>目標：計算 Mean Absolute Error (MAE)。<br>
</li>
<li><code>abs(e)</code>：取絕對值。<br>
</li>
<li>然後對這些絕對值取平均（同樣忽略 <code>NA</code>）。<br>
</li>
<li>執行結果：<code>mae(e)</code> 會回傳誤差絕對值的平均值。</li>
</ul></li>
<li><code>madm &lt;- function(e) median(abs(e), na.rm=TRUE)</code>
<ul>
<li>目標：計算 Median Absolute Deviation from the Median（這裡簡寫為 MAD）。<br>
</li>
<li>一樣先取絕對值，再算中位數 <code>median()</code>。<br>
</li>
<li>執行結果：<code>madm(e)</code> 會回傳一個數值，對離群值比較不敏感。</li>
</ul></li>
</ol>
</section>
<section id="建立-rolling-預測的索引與進度條" class="level2">
<h2 class="anchored" data-anchor-id="建立-rolling-預測的索引與進度條">1.3. 建立 Rolling 預測的索引與進度條</h2>
<p>這一節會： 1. 算出資料筆數。 2. 決定每次訓練集的結尾位置。 3. 建立用來收集結果的 list。 4. 建立進度條，讓長時間迴圈執行時比較有感。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- Rolling 預測 ----</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">開始 Rolling 預測...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>idx_train_end <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> train_len, <span class="at">to =</span> n <span class="sc">-</span> h, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(idx_train_end)) <span class="fu">stop</span>(<span class="st">"資料太短，請降低 train_len 或確認資料長度。"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>collect_ts <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(idx_train_end), <span class="at">style =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><code>cat("\n開始 Rolling 預測...\n")</code>
<ul>
<li>功能：先印一行空白（前面的 <code>\n</code>），再印「開始 Rolling 預測…」，再換行。<br>
</li>
<li>執行結果：在 console 給使用者一個明確的階段提示。</li>
</ul></li>
<li><code>n &lt;- nrow(dat)</code>
<ul>
<li><code>nrow(dat)</code>
<ul>
<li>功能：取得資料表 <code>dat</code> 的列數，也就是時間序列的觀測筆數。<br>
</li>
</ul></li>
<li>執行結果：<code>n</code> 是一個整數，代表全部可用的時間點數量。</li>
</ul></li>
<li><code>idx_train_end &lt;- seq(from = train_len, to = n - h, by = 1)</code>
<ul>
<li><code>seq(from = A, to = B, by = 1)</code>
<ul>
<li>功能：產生一個等差數列，從 <code>A</code> 到 <code>B</code>，每次加 1。<br>
</li>
</ul></li>
<li>這裡的意思是：
<ul>
<li>每個訓練集的「結尾 index」從 <code>train_len</code> 開始，一直到 <code>n - h</code>。<br>
</li>
<li><code>n - h</code> 是因為最後要留 <code>h</code> 期給未來預測。<br>
</li>
</ul></li>
<li>執行結果：<code>idx_train_end</code> 是一個整數向量，裡面每一個值都代表一個 rolling 訓練樣本的結尾位置。</li>
</ul></li>
<li><code>if (!length(idx_train_end)) stop("資料太短，請降低 train_len 或確認資料長度。")</code>
<ul>
<li><code>length(idx_train_end)</code> 回傳向量長度，如果是 0 代表完全產生不出訓練區間。<br>
</li>
<li><code>!length(idx_train_end)</code> 就是在檢查「長度是否為 0」。<br>
</li>
<li>如果是 0，用 <code>stop()</code> 終止程式，避免後面的迴圈出錯。<br>
</li>
<li>執行結果：資料太短時會直接報錯，提醒調整 <code>train_len</code> 或檢查資料。</li>
</ul></li>
<li><code>collect_ts &lt;- list()</code>
<ul>
<li>功能：建立一個空的 list，用來存放每一步 rolling 預測的結果。<br>
</li>
<li>為什麼用 list？因為每次的結果都是一個小 <code>data.table</code>，list 很適合先一筆一筆放，最後再合併。</li>
</ul></li>
<li><code>pb &lt;- txtProgressBar(min = 0, max = length(idx_train_end), style = 3)</code>
<ul>
<li><code>txtProgressBar()</code>
<ul>
<li>功能：建立文字介面的進度條物件。<br>
</li>
<li><code>min</code> 與 <code>max</code> 設定進度範圍，這裡是 0 到「總共要跑幾次 rolling」。<br>
</li>
<li><code>style = 3</code> 代表顯示形式（style 3 是常見的百分比進度條）。<br>
</li>
</ul></li>
<li>執行結果：<code>pb</code> 是一個進度條物件，之後搭配 <code>setTxtProgressBar(pb, i)</code> 就可以更新進度顯示。</li>
</ul></li>
</ol>
</section>
<section id="主要-rolling-預測迴圈與三種時間序列模型" class="level2">
<h2 class="anchored" data-anchor-id="主要-rolling-預測迴圈與三種時間序列模型">1.4. 主要 Rolling 預測迴圈與三種時間序列模型</h2>
<p>這一節是整支腳本的核心：<br>
用一個 <code>for</code> 迴圈，針對每個訓練結尾位置做以下事情：</p>
<ol type="1">
<li>切出訓練集與測試點。<br>
</li>
<li>建立三種模型：Random Walk、AR、ARMA。<br>
</li>
<li>預測第 <code>h</code> 期的值。<br>
</li>
<li>把每一步的預測結果整理成 <code>data.table</code>，存入 <code>collect_ts</code>。<br>
</li>
<li>更新進度條。</li>
</ol>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(idx_train_end)){</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  te <span class="ot">&lt;-</span> idx_train_end[i]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  train_idx <span class="ot">&lt;-</span> (te <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>te</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  test_idx  <span class="ot">&lt;-</span> te <span class="sc">+</span> h</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  tr     <span class="ot">&lt;-</span> dat[train_idx]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  te_row <span class="ot">&lt;-</span> dat[test_idx]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  y_tr <span class="ot">&lt;-</span> tr[[target_col]]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  y_te <span class="ot">&lt;-</span> te_row[[target_col]]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Random Walk</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  yhat_rw <span class="ot">&lt;-</span> <span class="fu">tail</span>(y_tr, <span class="dv">1</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## AR</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  fit_ar <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y_tr, <span class="at">d=</span><span class="dv">0</span>, <span class="at">max.q=</span><span class="dv">0</span>, <span class="at">seasonal=</span><span class="cn">FALSE</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stepwise=</span><span class="cn">TRUE</span>, <span class="at">approximation=</span><span class="cn">TRUE</span>), </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  yhat_ar <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(forecast<span class="sc">::</span><span class="fu">forecast</span>(fit_ar, <span class="at">h=</span>h)<span class="sc">$</span>mean[h]), </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) yhat_rw</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="do">## ARMA</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  fit_arma <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y_tr, <span class="at">d=</span><span class="dv">0</span>, <span class="at">seasonal=</span><span class="cn">FALSE</span>,</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stepwise=</span><span class="cn">TRUE</span>, <span class="at">approximation=</span><span class="cn">TRUE</span>), </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  yhat_arma <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(forecast<span class="sc">::</span><span class="fu">forecast</span>(fit_arma, <span class="at">h=</span>h)<span class="sc">$</span>mean[h]), </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) yhat_rw</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  collect_ts[[<span class="fu">length</span>(collect_ts)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> te_row[[time_col]],</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"RandomWalk"</span>,<span class="st">"AR"</span>,<span class="st">"ARMA"</span>),</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">y     =</span> y_te,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">yhat  =</span> <span class="fu">c</span>(yhat_rw, yhat_ar, yhat_arma)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(pb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明（逐段解析）：</p>
<ol type="1">
<li><p><code>for (i in seq_along(idx_train_end)) { ... }</code></p>
<ul>
<li><code>for</code> 迴圈：重複執行同一段程式碼，用來逐步處理每一個訓練結尾位置。<br>
</li>
<li><code>seq_along(idx_train_end)</code>：產生 <code>1, 2, ..., length(idx_train_end)</code> 的整數序列。<br>
</li>
<li><code>i</code>：目前在處理第幾個 rolling 切點。<br>
</li>
<li>執行結果：這段程式碼會從第一個訓練結尾位置一路跑到最後一個，對每個時間點都做一次「訓練 + 預測」。</li>
</ul></li>
<li><p><code>te &lt;- idx_train_end[i]</code></p>
<ul>
<li><code>te</code>（train end）：這一輪訓練集的最後一列 index。<br>
</li>
<li>執行結果：後面會用 <code>te</code> 來決定訓練與預測的位置。</li>
</ul></li>
<li><p><code>train_idx &lt;- (te - train_len + 1):te</code></p>
<ul>
<li>功能：產生訓練集的列 index 範圍。<br>
</li>
<li>範圍從「結尾往前推 <code>train_len - 1</code> 列」到 <code>te</code>。<br>
</li>
<li>執行結果：<code>train_idx</code> 會是一串整數，例如 <code>101:200</code>，用來切 <code>dat</code>。</li>
</ul></li>
<li><p><code>test_idx  &lt;- te + h</code></p>
<ul>
<li>功能：計算要預測的那個時間點 index，是在結尾後面第 <code>h</code> 期。<br>
</li>
<li>執行結果：<code>test_idx</code> 就是這一輪要拿來計算預測誤差的目標位置。</li>
</ul></li>
<li><p><code>tr &lt;- dat[train_idx]</code>、<code>te_row &lt;- dat[test_idx]</code></p>
<ul>
<li><code>dat[train_idx]</code>
<ul>
<li>功能：從原始資料 <code>dat</code> 切出訓練集子集。<br>
</li>
</ul></li>
<li><code>dat[test_idx]</code>
<ul>
<li>功能：取出測試那一列（這個時間點的真實值）。<br>
</li>
</ul></li>
<li>執行結果：
<ul>
<li><code>tr</code>：訓練資料（多列）。<br>
</li>
<li><code>te_row</code>：測試資料（一列）。</li>
</ul></li>
</ul></li>
<li><p><code>y_tr &lt;- tr[[target_col]]</code>、<code>y_te &lt;- te_row[[target_col]]</code></p>
<ul>
<li><code>[[ ]]</code> 取欄位：
<ul>
<li>功能：以欄位名稱（儲存在 <code>target_col</code> 這個字串）取出對應欄位。<br>
</li>
</ul></li>
<li><code>y_tr</code>：訓練期間的目標變數向量。<br>
</li>
<li><code>y_te</code>：測試那一列的真實目標值（單一數值）。</li>
</ul></li>
<li><p>Random Walk 模型：<code>yhat_rw &lt;- tail(y_tr, 1)</code></p>
<ul>
<li><code>tail(y_tr, 1)</code>
<ul>
<li>功能：取出 <code>y_tr</code> 最後一個觀測值。<br>
</li>
</ul></li>
<li>Random Walk 的預測邏輯：下一期的預測值等於上一期的實際值。<br>
</li>
<li>執行結果：<code>yhat_rw</code> 是這一輪的 Random Walk 預測值。</li>
</ul></li>
<li><p>AR 模型：<code>fit_ar &lt;- tryCatch(...)</code></p>
<ul>
<li><code>forecast::auto.arima(...)</code>
<ul>
<li>功能：自動選擇 ARIMA 模型的階數與參數。<br>
</li>
<li>這裡設定 <code>d=0, max.q=0, seasonal=FALSE</code>，所以只會選擇「純 AR 模型」(沒有差分、沒有 MA 部分、也沒有季節性)。<br>
</li>
<li><code>stepwise=TRUE</code>、<code>approximation=TRUE</code>：讓搜索過程比較快。<br>
</li>
</ul></li>
<li><code>tryCatch(..., error=function(e) NULL)</code>
<ul>
<li>功能：如果 <code>auto.arima()</code> 在某一輪失敗（例如資料特性不適合），就不要讓整個程式崩潰，而是回傳 <code>NULL</code>。<br>
</li>
</ul></li>
<li>執行結果：
<ul>
<li><code>fit_ar</code> 要嘛是一個 AR 模型物件，要嘛是 <code>NULL</code>（代表估計失敗）。</li>
</ul></li>
</ul></li>
<li><p>AR 預測值：<code>yhat_ar &lt;- tryCatch(as.numeric(forecast::forecast(fit_ar, h=h)$mean[h]), error=function(e) yhat_rw)</code></p>
<ul>
<li><code>forecast::forecast(fit_ar, h=h)</code>
<ul>
<li>功能：從已經估計好的 AR 模型 <code>fit_ar</code> 產生往後 <code>h</code> 期的預測。<br>
</li>
</ul></li>
<li><code>$mean[h]</code>
<ul>
<li>功能：取出第 <code>h</code> 期的預測平均值。<br>
</li>
</ul></li>
<li><code>as.numeric(...)</code>
<ul>
<li>功能：確保結果是單一的數值型態。<br>
</li>
</ul></li>
<li>外層 <code>tryCatch(..., error=function(e) yhat_rw)</code>
<ul>
<li>如果預測過程出錯（例如 <code>fit_ar</code> 是 <code>NULL</code>），就 fallback 回 Random Walk 的預測值 <code>yhat_rw</code>。<br>
</li>
</ul></li>
<li>執行結果：<code>yhat_ar</code> 永遠會有一個數值（即使模型失敗，也會用 <code>yhat_rw</code> 代替）。</li>
</ul></li>
<li><p>ARMA 模型與預測：<code>fit_arma</code> 與 <code>yhat_arma</code></p>
<ul>
<li><code>fit_arma &lt;- tryCatch(forecast::auto.arima(y_tr, d=0, seasonal=FALSE, ...), ...)</code>
<ul>
<li>這次只固定 <code>d=0</code>、<code>seasonal=FALSE</code>，但 <code>max.q</code> 沒有限制，所以允許 <code>p</code> 和 <code>q</code> 同時大於 0，也就是一般的 ARMA。<br>
</li>
</ul></li>
<li><code>yhat_arma &lt;- tryCatch(as.numeric(forecast::forecast(fit_arma, h=h)$mean[h]), error=function(e) yhat_rw)</code>
<ul>
<li>和 AR 的流程相同，只是用 ARMA 模型。<br>
</li>
<li>出錯時同樣退回 Random Walk 預測值。<br>
</li>
</ul></li>
<li>執行結果：<code>yhat_arma</code> 是 ARMA 模型在第 <code>h</code> 期的預測值。</li>
</ul></li>
<li><p>結果存入 <code>collect_ts</code>：</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>collect_ts[[<span class="fu">length</span>(collect_ts)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> te_row[[time_col]],</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"RandomWalk"</span>,<span class="st">"AR"</span>,<span class="st">"ARMA"</span>),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y     =</span> y_te,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">yhat  =</span> <span class="fu">c</span>(yhat_rw, yhat_ar, yhat_arma)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>length(collect_ts) + 1</code>
<ul>
<li>功能：在 list 的最後再加一個新元素。<br>
</li>
</ul></li>
<li><code>data.table(...)</code>
<ul>
<li>功能：建立一個 <code>data.table</code>，欄位說明：
<ul>
<li><code>date</code>：這次預測對應的時間點（從 <code>te_row</code> 的時間欄位取出）。<br>
</li>
<li><code>model</code>：模型名稱（字串向量，三列分別是 RandomWalk、AR、ARMA）。<br>
</li>
<li><code>y</code>：真實值（每列一樣，都是 <code>y_te</code>）。<br>
</li>
<li><code>yhat</code>：對應模型的預測值。<br>
</li>
</ul></li>
</ul></li>
<li>執行結果：<code>collect_ts</code> 會越來越長，每一個元素都包含三種模型在某個時間點的預測結果。</li>
</ul></li>
<li><p>更新進度條：<code>setTxtProgressBar(pb, i)</code></p>
<ul>
<li>功能：把進度條 <code>pb</code> 的目前值更新為 <code>i</code>。<br>
</li>
<li>執行結果：console 上的進度條會跟著迴圈更新，方便監控執行進度。</li>
</ul></li>
<li><p><code>close(pb)</code></p>
<ul>
<li>功能：迴圈結束後，把進度條關閉。<br>
</li>
<li>執行結果：進度條停止更新，畫面回到一般輸出。</li>
</ul></li>
</ol>
</section>
<section id="彙整所有-rolling-結果並計算誤差指標" class="level2">
<h2 class="anchored" data-anchor-id="彙整所有-rolling-結果並計算誤差指標">1.5. 彙整所有 Rolling 結果並計算誤差指標</h2>
<p>這一節會： 1. 把 <code>collect_ts</code> 裡面一個個 <code>data.table</code> 合併成一張大表。<br>
2. 移除預測值為缺失的資料列。<br>
3. 用前面定義的 <code>rmse</code>、<code>mae</code>、<code>madm</code> 對每個模型計算指標。<br>
4. 印出評分表。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 彙整結果 ----</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>roll_ts <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(collect_ts, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>roll_ts <span class="ot">&lt;-</span> roll_ts[<span class="sc">!</span><span class="fu">is.na</span>(yhat)]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">計算指標...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>score_ts <span class="ot">&lt;-</span> roll_ts[, .(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">rmse</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">mae</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAD  =</span> <span class="fu">madm</span>(y <span class="sc">-</span> yhat)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(model)]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score_ts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><p><code>roll_ts &lt;- rbindlist(collect_ts, fill=TRUE)</code></p>
<ul>
<li><code>rbindlist()</code>（來自 <code>data.table</code> 套件）
<ul>
<li>功能：把很多個相同結構的 <code>data.table</code> 依列堆疊起來（row bind）。<br>
</li>
<li><code>fill=TRUE</code> 代表如果欄位不完全相同，也會自動補上缺少的欄位為 <code>NA</code>。<br>
</li>
</ul></li>
<li>執行結果：<code>roll_ts</code> 會是一個長格式的資料表，每一列是一個時間點與一種模型的預測記錄。</li>
</ul></li>
<li><p><code>roll_ts &lt;- roll_ts[!is.na(yhat)]</code></p>
<ul>
<li><code>is.na(yhat)</code>：檢查 <code>yhat</code> 是否是缺失值。<br>
</li>
<li><code>!is.na(yhat)</code>：選出預測值不是缺失的列。<br>
</li>
<li><code>roll_ts[條件]</code>：<code>data.table</code> 的過濾語法，保留符合條件的列。<br>
</li>
<li>執行結果：確保之後計算指標時，不會用到沒有預測值的紀錄。</li>
</ul></li>
<li><p><code>cat("\n計算指標...\n")</code></p>
<ul>
<li>功能：在 console 印出「計算指標…」，前面加一個換行。<br>
</li>
<li>執行結果：讓使用者知道現在進入評估階段。</li>
</ul></li>
<li><p><code>score_ts &lt;- roll_ts[, .( ... ), by=.(model)]</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>score_ts <span class="ot">&lt;-</span> roll_ts[, .(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">rmse</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">mae</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAD  =</span> <span class="fu">madm</span>(y <span class="sc">-</span> yhat)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(model)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>這是 <code>data.table</code> 的分組運算語法：
<ul>
<li><code>by=.(model)</code>：依照欄位 <code>model</code> 分組（也就是針對每一種模型分別計算指標）。<br>
</li>
<li><code>.(RMSE = ..., MAE = ..., MAD = ...)</code>：產生一個新的小表，裡面有三個欄位：RMSE、MAE、MAD。<br>
</li>
</ul></li>
<li><code>y - yhat</code>：計算每一列的誤差（真實值減預測值）。<br>
</li>
<li><code>rmse(...)</code>、<code>mae(...)</code>、<code>madm(...)</code>：呼叫前面定義好的函數來計算指標。<br>
</li>
<li>執行結果：<code>score_ts</code> 是一張摘要表，每一列對應一種模型，欄位顯示該模型的 RMSE／MAE／MAD。</li>
</ul></li>
<li><p><code>print(score_ts)</code></p>
<ul>
<li>功能：把 <code>score_ts</code> 的內容印在 console。<br>
</li>
<li>執行結果：使用者可以直接在畫面上看到每個模型的預測表現，方便比較。</li>
</ul></li>
</ol>
</section>
<section id="儲存結果到-.rds-檔案" class="level2">
<h2 class="anchored" data-anchor-id="儲存結果到-.rds-檔案">1.6. 儲存結果到 .rds 檔案</h2>
<p>最後這一節會： 1. 把 <code>roll_ts</code> 與 <code>score_ts</code> 一起存成一個 <code>.rds</code> 檔。<br>
2. 在 console 印出儲存完成的路徑。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 儲存結果 ----</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">儲存結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">roll_ts =</span> roll_ts,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_ts =</span> score_ts</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>), <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ts.rds"</span>))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"時間序列模型完成！結果已儲存至 %s</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ts.rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><code>cat("\n儲存結果...\n")</code>
<ul>
<li>功能：印出提示訊息，告訴使用者現在正在儲存檔案。</li>
</ul></li>
<li><code>saveRDS(list(...), file.path(results_dir, "roll_ts.rds"))</code>
<ul>
<li><code>list(roll_ts = roll_ts, score_ts = score_ts)</code>
<ul>
<li>功能：把兩個物件打包成一個 list，方便一起存檔。<br>
</li>
<li><code>roll_ts</code>：每個時間點、每個模型的預測紀錄。<br>
</li>
<li><code>score_ts</code>：各模型的彙整指標。<br>
</li>
</ul></li>
<li><code>saveRDS(object, file)</code>
<ul>
<li>功能：把單一 R 物件存成 <code>.rds</code> 檔。<br>
</li>
<li>優點：讀取時會完整回復原本的 R 結構。<br>
</li>
</ul></li>
<li><code>file.path(results_dir, "roll_ts.rds")</code>
<ul>
<li>功能：組合出儲存路徑，例如 <code>outputs/h_3/results/roll_ts.rds</code>。<br>
</li>
</ul></li>
<li>執行結果：在對應的 <code>results_dir</code> 內產生一個 <code>roll_ts.rds</code> 檔案，裡面包含 <code>roll_ts</code> 與 <code>score_ts</code>。</li>
</ul></li>
<li><code>cat(sprintf("時間序列模型完成！結果已儲存至 %s\n", file.path(results_dir, "roll_ts.rds")))</code>
<ul>
<li><code>sprintf("時間序列模型完成！結果已儲存至 %s\n", 路徑)</code>
<ul>
<li>功能：把檔案路徑插入到字串中的 <code>%s</code>。<br>
</li>
</ul></li>
<li><code>cat(...)</code> 會把整句訊息印出來。<br>
</li>
<li>執行結果：console 會顯示類似<br>
<code>時間序列模型完成！結果已儲存至 outputs/h_3/results/roll_ts.rds</code><br>
方便使用者確認檔案存放位置。</li>
</ul></li>
</ol>
</section>
</section>
<section id="models_lasso.r---lasso-家族-lasso-ridge-elastic-net-adaptive-pcr" class="level1">
<h1>2_models_lasso.R - Lasso 家族 (Lasso / Ridge / Elastic Net / Adaptive / PCR)</h1>
<p>這份腳本示範如何使用 <strong>Lasso 家族模型</strong> 進行滾動式預測，包括 Lasso、Ridge、Elastic Net、Adaptive Lasso、Adaptive Elastic Net 與主成分回歸 (PCR)。</p>
<hr>
<section id="套件載入" class="level2">
<h2 class="anchored" data-anchor-id="套件載入">2.1. 套件載入</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>data.table</code>：提供高效能的資料處理、分組與運算功能，適合大樣本時間序列。<br>
</li>
<li><code>glmnet</code>：支援 Lasso、Ridge、Elastic Net 等懲罰化迴歸模型，可搭配交叉驗證自動選 λ。</li>
</ul>
<hr>
</section>
<section id="載入資料與設定" class="level2">
<h2 class="anchored" data-anchor-id="載入資料與設定">2.2. 載入資料與設定</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"載入資料...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> setup<span class="sc">$</span>dat</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>time_col</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>lag_vars <span class="ot">&lt;-</span> setup<span class="sc">$</span>lag_vars</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>train_len <span class="ot">&lt;-</span> setup<span class="sc">$</span>train_len</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>var_exp_cut <span class="ot">&lt;-</span> setup<span class="sc">$</span>var_exp_cut</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>elastic_alpha <span class="ot">&lt;-</span> setup<span class="sc">$</span>elastic_alpha</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>adapt_gamma <span class="ot">&lt;-</span> setup<span class="sc">$</span>adapt_gamma</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> setup<span class="sc">$</span>output_root</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"使用 h = %d 的資料</span><span class="sc">\n</span><span class="st">"</span>, h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>檢查是否存在 <code>h</code> 變數（預測步數）。<br>
</li>
<li>根據 <code>h</code> 指定對應資料夾，例如 <code>outputs/h_3/results</code>。<br>
</li>
<li>讀取事先由 <code>0_setup.R</code> 生成的 <code>prepared_data.rds</code>。<br>
</li>
<li>提取模型所需欄位與參數，如 <code>lag_vars</code>、<code>elastic_alpha</code>、<code>adapt_gamma</code> 等。</li>
</ol>
<hr>
</section>
<section id="定義誤差衡量函數" class="level2">
<h2 class="anchored" data-anchor-id="定義誤差衡量函數">2.3. 定義誤差衡量函數</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">sqrt</span>(<span class="fu">mean</span>(e<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>mae  <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">mean</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>madm <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">median</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>rmse()</code>：均方根誤差，用於測量整體預測偏差。<br>
</li>
<li><code>mae()</code>：平均絕對誤差，代表平均偏差大小。<br>
</li>
<li><code>madm()</code>：絕對誤差中位數，比 MAE 對極端值更穩定。</li>
</ul>
<hr>
</section>
<section id="設定-glmnet-共同參數" class="level2">
<h2 class="anchored" data-anchor-id="設定-glmnet-共同參數">2.4. 設定 glmnet 共同參數</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>glmnet_common <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">standardize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxit =</span> <span class="fl">1e6</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">nlambda =</span> <span class="dv">80</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda.min.ratio =</span> <span class="fl">1e-3</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<p>這些參數會在多種模型中共用：</p>
<ul>
<li><code>standardize = TRUE</code>：對變數進行標準化。<br>
</li>
<li><code>maxit = 1e6</code>：最大迭代次數。<br>
</li>
<li><code>nlambda = 80</code>：λ 值的取樣數量。<br>
</li>
<li><code>lambda.min.ratio = 1e-3</code>：最小 λ 與最大 λ 的比例，用於控制懲罰強度範圍。</li>
</ul>
<hr>
</section>
<section id="rolling-預測架構" class="level2">
<h2 class="anchored" data-anchor-id="rolling-預測架構">2.5. Rolling 預測架構</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">開始 Rolling 預測...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>idx_train_end <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> train_len, <span class="at">to =</span> n <span class="sc">-</span> h, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(idx_train_end)) <span class="fu">stop</span>(<span class="st">"資料太短，請降低 train_len 或確認資料長度。"</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>collect_lasso <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(idx_train_end), <span class="at">style =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>建立滾動預測索引，每次使用 <code>train_len</code> 筆資料作訓練。<br>
</li>
<li><code>txtProgressBar()</code>：顯示進度條。</li>
</ul>
<hr>
</section>
<section id="主迴圈模型訓練與預測" class="level2">
<h2 class="anchored" data-anchor-id="主迴圈模型訓練與預測">2.6. 主迴圈：模型訓練與預測</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(idx_train_end)){</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  te <span class="ot">&lt;-</span> idx_train_end[i]</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  train_idx <span class="ot">&lt;-</span> (te <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>te</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  test_idx  <span class="ot">&lt;-</span> te <span class="sc">+</span> h</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  tr     <span class="ot">&lt;-</span> dat[train_idx]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  te_row <span class="ot">&lt;-</span> dat[test_idx]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  y_tr <span class="ot">&lt;-</span> tr[[target_col]]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  y_te <span class="ot">&lt;-</span> te_row[[target_col]]</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 準備特徵矩陣</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  X_tr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(tr[, ..lag_vars])</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  X_te <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(te_row[, ..lag_vars])</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  good <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(X_tr)) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  X_tr <span class="ot">&lt;-</span> X_tr[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  X_te <span class="ot">&lt;-</span> X_te[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 過濾近零變異</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">ncol</span>(X_tr) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    sd_ok <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_tr, <span class="dv">2</span>, sd, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="fl">1e-8</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    X_tr  <span class="ot">&lt;-</span> X_tr[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    X_te  <span class="ot">&lt;-</span> X_te[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(X_tr) <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lasso</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    fit_lasso <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span><span class="dv">1</span>), glmnet_common)),</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    yhat_lasso <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_lasso)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_lasso, X_te, <span class="at">s=</span><span class="st">"lambda.1se"</span>)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    fit_ridge <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span><span class="dv">0</span>), glmnet_common)),</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    yhat_ridge <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_ridge)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_ridge, X_te, <span class="at">s=</span><span class="st">"lambda.1se"</span>)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Elastic Net</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>    fit_en <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span>elastic_alpha), glmnet_common)),</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>    yhat_en <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_en)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_en, X_te, <span class="at">s=</span><span class="st">"lambda.1se"</span>)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adaptive 權重（以 Ridge 初估）</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>    w_al <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>      fit0 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span><span class="dv">0</span>), glmnet_common))</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>      b0   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">coef</span>(fit0, <span class="at">s=</span><span class="st">"lambda.1se"</span>))[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>      w    <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fu">abs</span>(b0)<span class="sc">^</span>adapt_gamma <span class="sc">+</span> <span class="fl">1e-6</span>)</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pmin</span>(w, <span class="fl">1e4</span>)</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error=</span><span class="cf">function</span>(e) <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">ncol</span>(X_tr)))</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adaptive Lasso</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>    fit_ada_lasso <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">penalty.factor=</span>w_al), glmnet_common)),</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>    yhat_ada_lasso <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_ada_lasso)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_ada_lasso, X_te, <span class="at">s=</span><span class="st">"lambda.1se"</span>)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adaptive Elastic Net</span></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>    fit_ada_en <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">do.call</span>(cv.glmnet, <span class="fu">c</span>(<span class="fu">list</span>(<span class="at">x=</span>X_tr, <span class="at">y=</span>y_tr, <span class="at">alpha=</span>elastic_alpha, <span class="at">penalty.factor=</span>w_al), glmnet_common)),</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    yhat_ada_en <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_ada_en)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_ada_en, X_te, <span class="at">s=</span><span class="st">"lambda.1se"</span>)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PCR</span></span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    pca <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">prcomp</span>(X_tr, <span class="at">center=</span><span class="cn">TRUE</span>, <span class="at">scale.=</span><span class="cn">TRUE</span>), <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    yhat_pcr <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(pca)){</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>      var_exp <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sum</span>(pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>      k <span class="ot">&lt;-</span> <span class="fu">which</span>(var_exp <span class="sc">&gt;=</span> var_exp_cut)[<span class="dv">1</span>]</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>      Z_tr <span class="ot">&lt;-</span> pca<span class="sc">$</span>x[,<span class="dv">1</span><span class="sc">:</span>k,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>      Z_te <span class="ot">&lt;-</span> <span class="fu">scale</span>(X_te, <span class="at">center=</span>pca<span class="sc">$</span>center, <span class="at">scale=</span>pca<span class="sc">$</span>scale) <span class="sc">%*%</span> pca<span class="sc">$</span>rotation[,<span class="dv">1</span><span class="sc">:</span>k,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>      fit_pcr <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">lm</span>(y_tr <span class="sc">~</span> Z_tr), <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_pcr)) yhat_pcr <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, Z_te) <span class="sc">%*%</span> <span class="fu">coef</span>(fit_pcr))</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    collect_lasso[[<span class="fu">length</span>(collect_lasso)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> te_row[[time_col]],</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Lasso"</span>,<span class="st">"Ridge"</span>,<span class="st">"ElasticNet"</span>,<span class="st">"AdaLasso"</span>,<span class="st">"AdaElasticNet"</span>,<span class="st">"PCR"</span>),</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>      <span class="at">y     =</span> y_te,</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">yhat  =</span> <span class="fu">c</span>(yhat_lasso,yhat_ridge,yhat_en,yhat_ada_lasso,yhat_ada_en,yhat_pcr)</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(pb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明（要點）：</p>
<ul>
<li><code>cv.glmnet()</code>：進行交叉驗證選擇最優 λ。<br>
</li>
<li><code>alpha = 1</code> → Lasso；<code>alpha = 0</code> → Ridge；介於 0~1 為 Elastic Net。<br>
</li>
<li><code>penalty.factor</code>：給不同變數不同懲罰強度，用於 Adaptive Lasso。<br>
</li>
<li><code>prcomp()</code>：主成分分析，挑出能解釋達指定比例變異的成分（<code>var_exp_cut</code>）。</li>
</ul>
<hr>
</section>
<section id="彙整結果與評估指標" class="level2">
<h2 class="anchored" data-anchor-id="彙整結果與評估指標">2.7. 彙整結果與評估指標</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>roll_lasso <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(collect_lasso, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>roll_lasso <span class="ot">&lt;-</span> roll_lasso[<span class="sc">!</span><span class="fu">is.na</span>(yhat)]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">計算指標...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>score_lasso <span class="ot">&lt;-</span> roll_lasso[, .(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">rmse</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">mae</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAD  =</span> <span class="fu">madm</span>(y <span class="sc">-</span> yhat)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(model)]</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score_lasso)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>使用 <code>rbindlist()</code> 合併所有迴圈結果。<br>
</li>
<li>去除 <code>yhat</code> 為 NA 的紀錄。<br>
</li>
<li>依模型計算 RMSE、MAE、MAD。</li>
</ol>
<hr>
</section>
<section id="儲存結果" class="level2">
<h2 class="anchored" data-anchor-id="儲存結果">2.8. 儲存結果</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">roll_lasso =</span> roll_lasso,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_lasso =</span> score_lasso</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>), <span class="fu">file.path</span>(results_dir, <span class="st">"roll_lasso.rds"</span>))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Lasso 家族模型完成！結果已儲存至 %s</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(results_dir, <span class="st">"roll_lasso.rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>saveRDS()</code>：把滾動預測結果與評估指標一併儲存成 <code>.rds</code> 檔案。<br>
</li>
<li>儲存後會在 console 顯示完成訊息，指出輸出檔路徑。</li>
</ul>
<hr>
</section>
</section>
<section id="models_ml.r-說明文件" class="level1">
<h1>3_models_ml.R 說明文件</h1>
<section id="套件載入與腳本說明" class="level2">
<h2 class="anchored" data-anchor-id="套件載入與腳本說明">3.1. 套件載入與腳本說明</h2>
<p>這一節保留原始檔案的標題註解，並載入本腳本會用到的三個套件。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ============================================================================</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="do">## 3_models_ml.R - 機器學習模型 (Bagging Tree / Random Forest)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ============================================================================</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipred)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><p>上面三行 <code>## ===</code> 是註解，只是說明這支檔案的用途（做機器學習模型：Bagging Tree / Random Forest），不會被 R 執行。</p></li>
<li><p><code>library(data.table)</code></p>
<ul>
<li>功能：載入 <code>data.table</code> 套件。<br>
</li>
<li>這個套件提供高效能的資料表結構與分組運算語法，例如 <code>DT[, .(mean_y = mean(y)), by = group]</code>。<br>
</li>
<li>在這支腳本中，我們會用到 <code>data.table()</code>、<code>rbindlist()</code> 以及 <code>DT[...]</code> 這類語法。</li>
</ul></li>
<li><p><code>library(ipred)</code></p>
<ul>
<li>功能：載入 <code>ipred</code> 套件（Improved Prediction）。<br>
</li>
<li>這個套件提供 Bagging（Bootstrap Aggregating）等 ensemble 方法，我們會用到 <code>bagging()</code> 來建立 Bagging Tree 模型。</li>
</ul></li>
<li><p><code>library(ranger)</code></p>
<ul>
<li>功能：載入 <code>ranger</code> 套件。<br>
</li>
<li><code>ranger</code> 是一個高效能的 Random Forest 實作，適合中大型資料集。<br>
</li>
<li>我們會用 <code>ranger()</code> 來訓練 Random Forest，並用 <code>predict()</code> 取得預測值。</li>
</ul></li>
</ol>
</section>
<section id="載入準備好的資料與基本設定" class="level2">
<h2 class="anchored" data-anchor-id="載入準備好的資料與基本設定">3.2. 載入準備好的資料與基本設定</h2>
<p>這一節：</p>
<ol type="1">
<li>印出提示訊息。<br>
</li>
<li>檢查 <code>h</code> 是否存在。<br>
</li>
<li>根據 <code>h</code> 找到對應資料夾並讀入之前準備好的 RDS 檔。<br>
</li>
<li>從中取出要用的資料與參數。</li>
</ol>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 載入準備好的資料 ----</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"載入資料...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 用目前的 h 找資料夾（平行跑才不會亂）</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> setup<span class="sc">$</span>dat</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>time_col</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>lag_vars <span class="ot">&lt;-</span> setup<span class="sc">$</span>lag_vars</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>train_len <span class="ot">&lt;-</span> setup<span class="sc">$</span>train_len</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> setup<span class="sc">$</span>output_root</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"使用 h = %d 的資料</span><span class="sc">\n</span><span class="st">"</span>, h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><p><code>cat("載入資料...\n")</code></p>
<ul>
<li><code>cat()</code>：在 console 印出字串。<br>
</li>
<li><code>\n</code>：換行符號。<br>
</li>
<li>執行結果：畫面顯示「載入資料…」，提示現在在進行資料讀取的步驟。</li>
</ul></li>
<li><p><code>if (!exists("h")) stop("沒有設定 h，請在外面給 h 再跑這支 script。")</code></p>
<ul>
<li><code>exists("h")</code>：檢查目前環境中是否有名為 <code>h</code> 的物件。<br>
</li>
<li><code>!exists("h")</code>：如果沒有這個物件就會是 TRUE。<br>
</li>
<li><code>stop("...")</code>：立刻中止程式並顯示錯誤訊息。<br>
</li>
<li>執行結果：如果在外部沒有預先設定 <code>h</code>（預測步數），腳本會在這裡停住，避免用錯資料。</li>
</ul></li>
<li><p><code>results_dir &lt;- file.path("outputs", paste0("h_", h), "results")</code></p>
<ul>
<li><code>paste0("h_", h)</code>：把 <code>"h_"</code> 和整數 <code>h</code> 串在一起，例如 <code>h = 3</code> 時得到 <code>"h_3"</code>。<br>
</li>
<li><code>file.path(...)</code>：依作業系統使用適當分隔符號（<code>/</code> 或 <code>\</code>）組出路徑。<br>
</li>
<li>執行結果：<code>results_dir</code> 類似 <code>"outputs/h_3/results"</code>，代表這個 horizon 的結果資料夾。</li>
</ul></li>
<li><p><code>if (!dir.exists(results_dir)) stop(...)</code></p>
<ul>
<li><code>dir.exists(results_dir)</code>：檢查資料夾是否存在。<br>
</li>
<li>如果不存在，呼叫 <code>stop()</code> 提示要先執行 <code>0_setup.R</code> 準備好資料。</li>
</ul></li>
<li><p><code>setup &lt;- readRDS(file.path(results_dir, "prepared_data.rds"))</code></p>
<ul>
<li><code>readRDS()</code>：讀取 <code>.rds</code> 檔案（單一 R 物件）。<br>
</li>
<li><code>file.path(results_dir, "prepared_data.rds")</code>：組出檔案路徑。<br>
</li>
<li>執行結果：<code>setup</code> 通常是一個 list，裡面包含前處理後的資料與相關設定。</li>
</ul></li>
<li><p>從 <code>setup</code> 取出各元素：</p>
<ul>
<li><code>dat &lt;- setup$dat</code>：完整資料（多半是 <code>data.table</code>）。<br>
</li>
<li><code>target_col &lt;- setup$target_col</code>：要預測的目標欄位名稱。<br>
</li>
<li><code>time_col &lt;- setup$time_col</code>：時間欄位名稱。<br>
</li>
<li><code>lag_vars &lt;- setup$lag_vars</code>：特徵（例如 lag 變數）的欄位名稱向量。<br>
</li>
<li><code>train_len &lt;- setup$train_len</code>：每次訓練集的長度。<br>
</li>
<li><code>h &lt;- setup$h</code>：預測步數，從 <code>setup</code> 再取一次，保證一致。<br>
</li>
<li><code>output_root &lt;- setup$output_root</code>：輸出檔案根目錄。</li>
</ul></li>
<li><p><code>cat(sprintf("使用 h = %d 的資料\n", h))</code></p>
<ul>
<li><code>sprintf("使用 h = %d 的資料\n", h)</code>：把 <code>h</code> 代入 <code>%d</code>，產生一行字串。<br>
</li>
<li><code>cat()</code>：印出字串。<br>
</li>
<li>執行結果：例如 <code>h = 3</code> 時，會在 console 顯示「使用 h = 3 的資料」。</li>
</ul></li>
</ol>
</section>
<section id="定義預測誤差指標函數" class="level2">
<h2 class="anchored" data-anchor-id="定義預測誤差指標函數">3.3. 定義預測誤差指標函數</h2>
<p>這一節定義 RMSE、MAE、MAD 三個常用指標。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 指標函數 ----</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">sqrt</span>(<span class="fu">mean</span>(e<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>mae  <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">mean</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>madm <span class="ot">&lt;-</span> <span class="cf">function</span>(e) <span class="fu">median</span>(<span class="fu">abs</span>(e), <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>基本函數寫法
<ul>
<li><code>rmse &lt;- function(e) ...</code>：建立一個名稱為 <code>rmse</code> 的函數，輸入參數是誤差向量 <code>e</code>。<br>
</li>
<li>這裡用單行形式，直接把右邊的運算結果當成回傳值。</li>
</ul></li>
<li><code>rmse &lt;- function(e) sqrt(mean(e^2, na.rm=TRUE))</code>
<ul>
<li><code>e^2</code>：逐元素平方。<br>
</li>
<li><code>mean(..., na.rm=TRUE)</code>：平均平方誤差（忽略 NA）。<br>
</li>
<li><code>sqrt(...)</code>：開根號得到 Root Mean Squared Error。</li>
</ul></li>
<li><code>mae  &lt;- function(e) mean(abs(e), na.rm=TRUE)</code>
<ul>
<li><code>abs(e)</code>：取誤差絕對值。<br>
</li>
<li><code>mean()</code>：取得這些絕對值的平均，得到 Mean Absolute Error。</li>
</ul></li>
<li><code>madm &lt;- function(e) median(abs(e), na.rm=TRUE)</code>
<ul>
<li><code>median()</code>：中位數。<br>
</li>
<li>對誤差絕對值取中位數，得到一個對離群值較不敏感的尺度。</li>
</ul></li>
</ol>
</section>
<section id="建立-rolling-預測索引與進度條" class="level2">
<h2 class="anchored" data-anchor-id="建立-rolling-預測索引與進度條">3.4. 建立 Rolling 預測索引與進度條</h2>
<p>這一節會：</p>
<ol type="1">
<li>計算資料筆數。<br>
</li>
<li>產生訓練集結尾位置的序列。<br>
</li>
<li>準備存放結果的 list。<br>
</li>
<li>建立進度條。</li>
</ol>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- Rolling 預測 ----</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">開始 Rolling 預測...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>idx_train_end <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> train_len, <span class="at">to =</span> n <span class="sc">-</span> h, <span class="at">by =</span> <span class="dv">1</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(idx_train_end)) <span class="fu">stop</span>(<span class="st">"資料太短，請降低 train_len 或確認資料長度。"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>collect_ml <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">length</span>(idx_train_end), <span class="at">style =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><code>cat("\n開始 Rolling 預測...\n")</code>
<ul>
<li>前面的 <code>\n</code> 先換行一次，後面再顯示「開始 Rolling 預測…」。<br>
</li>
<li>執行結果：console 上清楚顯示進入 Rolling 預測階段。</li>
</ul></li>
<li><code>n &lt;- nrow(dat)</code>
<ul>
<li><code>nrow(dat)</code>：取得資料表的列數。<br>
</li>
<li><code>n</code> 是觀測筆數，用來決定可以做幾輪 Rolling。</li>
</ul></li>
<li><code>idx_train_end &lt;- seq(from = train_len, to = n - h, by = 1)</code>
<ul>
<li><code>seq(from, to, by)</code>：產生等差數列。<br>
</li>
<li>從 <code>train_len</code> 開始，到 <code>n - h</code> 為止，間隔 1。<br>
</li>
<li>每個數字代表「訓練集結尾的 index」。<br>
</li>
<li>為什麼是 <code>n - h</code>：因為還要保留 <code>h</code> 期給未來的預測點。</li>
</ul></li>
<li><code>if (!length(idx_train_end)) stop("資料太短，請降低 train_len 或確認資料長度。")</code>
<ul>
<li><code>length(idx_train_end)</code>：看有沒有任何訓練切點。<br>
</li>
<li>長度為 0 代表無法組出訓練集，直接 <code>stop()</code> 中止程式並提醒。</li>
</ul></li>
<li><code>collect_ml &lt;- list()</code>
<ul>
<li>建立空的 list，之後每一輪 Rolling 產生的結果都會 append 進來。</li>
</ul></li>
<li><code>pb &lt;- txtProgressBar(min = 0, max = length(idx_train_end), style = 3)</code>
<ul>
<li><code>txtProgressBar()</code>：建立文字模式的進度條。<br>
</li>
<li><code>min</code> 與 <code>max</code>：進度從 0 到總迴圈次數。<br>
</li>
<li><code>style = 3</code>：顯示百分比與進度條。<br>
</li>
<li>執行結果：Console 上會有一條進度條，搭配後面的 <code>setTxtProgressBar(pb, i)</code> 更新。</li>
</ul></li>
</ol>
</section>
<section id="rolling-迴圈建模與預測bagging-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="rolling-迴圈建模與預測bagging-random-forest">3.5. Rolling 迴圈：建模與預測（Bagging / Random Forest）</h2>
<p>這一節是核心 for 迴圈。對每個訓練結尾：</p>
<ol type="1">
<li>切訓練集與測試點。<br>
</li>
<li>準備特徵矩陣並清理缺失與近零變異欄位。<br>
</li>
<li>建立 Bagging Tree 與 Random Forest 模型。<br>
</li>
<li>收集兩個模型的預測結果。</li>
</ol>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(idx_train_end)){</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  te <span class="ot">&lt;-</span> idx_train_end[i]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  train_idx <span class="ot">&lt;-</span> (te <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>te</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  test_idx  <span class="ot">&lt;-</span> te <span class="sc">+</span> h</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  tr     <span class="ot">&lt;-</span> dat[train_idx]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  te_row <span class="ot">&lt;-</span> dat[test_idx]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  y_tr <span class="ot">&lt;-</span> tr[[target_col]]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  y_te <span class="ot">&lt;-</span> te_row[[target_col]]</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 準備特徵矩陣</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  X_tr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(tr[, ..lag_vars])</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>  X_te <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(te_row[, ..lag_vars])</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  good <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(X_tr)) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  X_tr <span class="ot">&lt;-</span> X_tr[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  X_te <span class="ot">&lt;-</span> X_te[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## 過濾近零變異</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">ncol</span>(X_tr) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    sd_ok <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_tr, <span class="dv">2</span>, sd, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="fl">1e-8</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    X_tr  <span class="ot">&lt;-</span> X_tr[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    X_te  <span class="ot">&lt;-</span> X_te[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">ncol</span>(X_tr) <span class="sc">&gt;=</span> <span class="dv">1</span>){</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    tr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_tr, X_tr)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    te_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X_te)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Bagging</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    fit_bag <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>      ipred<span class="sc">::</span><span class="fu">bagging</span>(y <span class="sc">~</span> ., <span class="at">data=</span>tr_df, <span class="at">coob=</span><span class="cn">TRUE</span>, <span class="at">nbagg=</span><span class="dv">100</span>),</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    yhat_bag <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_bag)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_bag, <span class="at">newdata=</span>te_df)) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Random Forest</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    fit_rf <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>      ranger<span class="sc">::</span><span class="fu">ranger</span>(y <span class="sc">~</span> ., <span class="at">data=</span>tr_df,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">num.trees=</span><span class="dv">500</span>,</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mtry=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(X_tr)))),</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>                     <span class="at">min.node.size=</span><span class="dv">5</span>),</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    yhat_rf <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_rf)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_rf, <span class="at">data=</span>te_df)<span class="sc">$</span>predictions) <span class="cf">else</span> <span class="cn">NA_real_</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    collect_ml[[<span class="fu">length</span>(collect_ml)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.table</span>(<span class="at">date =</span> te_row[[time_col]], <span class="at">model=</span><span class="st">"BaggingTree"</span>,  <span class="at">y=</span>y_te, <span class="at">yhat=</span>yhat_bag),</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">data.table</span>(<span class="at">date =</span> te_row[[time_col]], <span class="at">model=</span><span class="st">"RandomForest"</span>, <span class="at">y=</span>y_te, <span class="at">yhat=</span>yhat_rf)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(pb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明（依區塊說）：</p>
<ol type="1">
<li><p><code>for (i in seq_along(idx_train_end)) { ... }</code></p>
<ul>
<li><code>seq_along(idx_train_end)</code>：產生 <code>1, 2, ..., length(idx_train_end)</code>。<br>
</li>
<li><code>for</code> 迴圈依序處理每一個訓練結尾位置。<br>
</li>
<li>執行結果：整個 Rolling 過程會跑多輪，每輪做一次「訓練 + 預測」。</li>
</ul></li>
<li><p>切訓練與測試資料：</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>te <span class="ot">&lt;-</span> idx_train_end[i]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>train_idx <span class="ot">&lt;-</span> (te <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>te</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>test_idx  <span class="ot">&lt;-</span> te <span class="sc">+</span> h</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>tr     <span class="ot">&lt;-</span> dat[train_idx]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>te_row <span class="ot">&lt;-</span> dat[test_idx]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>y_tr <span class="ot">&lt;-</span> tr[[target_col]]</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>y_te <span class="ot">&lt;-</span> te_row[[target_col]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>te</code>：當前訓練集的最後一列 index。<br>
</li>
<li><code>train_idx</code>：從 <code>te - train_len + 1</code> 到 <code>te</code>，就是訓練集範圍。<br>
</li>
<li><code>test_idx</code>：預測目標 index，在 <code>te</code> 後面第 <code>h</code> 期。<br>
</li>
<li><code>tr &lt;- dat[train_idx]</code>：切出訓練資料。<br>
</li>
<li><code>te_row &lt;- dat[test_idx]</code>：取得測試那一列。<br>
</li>
<li><code>y_tr</code>：訓練期間的 y。<br>
</li>
<li><code>y_te</code>：測試點的真實 y 值。</li>
</ul></li>
<li><p>準備特徵矩陣、處理缺失：</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(tr[, ..lag_vars])</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>X_te <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(te_row[, ..lag_vars])</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>good <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(X_tr)) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> X_tr[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>X_te <span class="ot">&lt;-</span> X_te[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>tr[, ..lag_vars]</code>：<code>data.table</code> 語法，選取欄位名稱在 <code>lag_vars</code> 中的那些欄位。前面的 <code>..</code> 是引用變數 <code>lag_vars</code>。<br>
</li>
<li><code>as.matrix(...)</code>：將資料轉成數值矩陣，方便後續演算法使用。<br>
</li>
<li><code>colSums(is.na(X_tr))</code>：計算每一欄的缺失值個數。<br>
</li>
<li><code>good &lt;- ... == 0</code>：只保留完整無缺失的欄位。<br>
</li>
<li><code>X_tr &lt;- X_tr[, good, drop=FALSE]</code>：篩選欄位。<code>drop=FALSE</code> 確保剩下一欄時仍是矩陣。<br>
</li>
<li><code>X_te</code> 同樣刪掉對應欄位，保持訓練與測試的欄位一致。</li>
</ul></li>
<li><p>過濾近零變異欄位：</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">ncol</span>(X_tr) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  sd_ok <span class="ot">&lt;-</span> <span class="fu">apply</span>(X_tr, <span class="dv">2</span>, sd, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="fl">1e-8</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  X_tr  <span class="ot">&lt;-</span> X_tr[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  X_te  <span class="ot">&lt;-</span> X_te[, sd_ok, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>ncol(X_tr)</code>：看目前還有幾個特徵欄位。<br>
</li>
<li><code>apply(X_tr, 2, sd, na.rm=TRUE)</code>：對每一欄（margin=2）計算標準差。<br>
</li>
<li><code>sd_ok &lt;- ... &gt; 1e-8</code>：標準差太小的欄位視為「幾乎沒變動」，資訊量低，可能造成數值問題，因此排除。<br>
</li>
<li>之後再次篩選欄位，保留 <code>sd_ok</code> 為 TRUE 的欄位。</li>
</ul></li>
<li><p>確認至少有一個特徵：<code>if (ncol(X_tr) &gt;= 1) { ... }</code></p>
<ul>
<li>若沒有特徵，就不要進行模型訓練，避免函數報錯。</li>
</ul></li>
<li><p>建立 data.frame 給模型使用：</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>tr_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y_tr, X_tr)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>te_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(X_te)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>某些模型函數（例如 <code>bagging()</code>、<code>ranger()</code>）喜歡 formula + data 的介面，需要 <code>data.frame</code>。<br>
</li>
<li><code>tr_df</code>：包含目標變數 <code>y</code> 和特徵欄位。<br>
</li>
<li><code>te_df</code>：只包含特徵欄位（沒有 y），用來做預測。</li>
</ul></li>
<li><p>Bagging Tree 模型：</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fit_bag <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  ipred<span class="sc">::</span><span class="fu">bagging</span>(y <span class="sc">~</span> ., <span class="at">data=</span>tr_df, <span class="at">coob=</span><span class="cn">TRUE</span>, <span class="at">nbagg=</span><span class="dv">100</span>),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>yhat_bag <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_bag)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_bag, <span class="at">newdata=</span>te_df)) <span class="cf">else</span> <span class="cn">NA_real_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>ipred::bagging(y ~ ., data=tr_df, coob=TRUE, nbagg=100)</code>：
<ul>
<li><code>y ~ .</code>：formula 寫法，左邊 <code>y</code> 是目標，右邊 <code>.</code> 代表使用其他所有欄位當特徵。<br>
</li>
<li><code>data=tr_df</code>：訓練資料。<br>
</li>
<li><code>coob=TRUE</code>：計算 out-of-bag 預測誤差（共用但這裡沒有特別使用結果）。<br>
</li>
<li><code>nbagg=100</code>：使用 100 棵樹（100 次 bootstrap）。<br>
</li>
</ul></li>
<li><code>tryCatch(..., error=function(e) NULL)</code>：如果訓練過程出現錯誤，就回傳 <code>NULL</code>，避免整個程式中斷。<br>
</li>
<li><code>predict(fit_bag, newdata=te_df)</code>：對測試資料 <code>te_df</code> 做預測。<br>
</li>
<li><code>as.numeric(...)</code>：確定輸出是單一數值。<br>
</li>
<li>若 <code>fit_bag</code> 是 <code>NULL</code>，就改用 <code>NA_real_</code> 作為預測值，表示該輪失敗。</li>
</ul></li>
<li><p>Random Forest 模型（ranger）：</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fit_rf <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  ranger<span class="sc">::</span><span class="fu">ranger</span>(y <span class="sc">~</span> ., <span class="at">data=</span>tr_df,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">num.trees=</span><span class="dv">500</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mtry=</span><span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">ncol</span>(X_tr)))),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.node.size=</span><span class="dv">5</span>),</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>yhat_rf <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fit_rf)) <span class="fu">as.numeric</span>(<span class="fu">predict</span>(fit_rf, <span class="at">data=</span>te_df)<span class="sc">$</span>predictions) <span class="cf">else</span> <span class="cn">NA_real_</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>ranger::ranger(y ~ ., data=tr_df, ...)</code>：
<ul>
<li><code>y ~ .</code>：同樣的 formula，使用所有其他欄位當特徵。<br>
</li>
<li><code>num.trees=500</code>：使用 500 棵樹。<br>
</li>
<li><code>mtry=max(1, floor(sqrt(ncol(X_tr))))</code>：
<ul>
<li><code>ncol(X_tr)</code>：特徵數。<br>
</li>
<li><code>sqrt(ncol(X_tr))</code>：常見預設，Random Forest 每次分裂考慮的變數數量。<br>
</li>
<li><code>floor()</code>：取整數。<br>
</li>
<li><code>max(1, ...)</code>：至少要考慮 1 個變數。<br>
</li>
</ul></li>
<li><code>min.node.size=5</code>：每個葉節點的最小觀測數，避免樹分得太細。<br>
</li>
</ul></li>
<li>同樣用 <code>tryCatch</code> 包起來，錯誤時回傳 <code>NULL</code>。<br>
</li>
<li><code>predict(fit_rf, data=te_df)$predictions</code>：
<ul>
<li><code>predict()</code> 回傳一個列表，我們從中取出 <code>$predictions</code> 當預測值。<br>
</li>
</ul></li>
<li><code>as.numeric(...)</code>：轉成單一數值。<br>
</li>
<li>若模型為 <code>NULL</code>，就回傳 <code>NA_real_</code>。</li>
</ul></li>
<li><p>收集兩個模型的預測結果：</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>collect_ml[[<span class="fu">length</span>(collect_ml)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">date =</span> te_row[[time_col]], <span class="at">model=</span><span class="st">"BaggingTree"</span>,  <span class="at">y=</span>y_te, <span class="at">yhat=</span>yhat_bag),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">date =</span> te_row[[time_col]], <span class="at">model=</span><span class="st">"RandomForest"</span>, <span class="at">y=</span>y_te, <span class="at">yhat=</span>yhat_rf)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>data.table(...)</code>：建立兩個小 <code>data.table</code>：一列 Bagging，一列 Random Forest。
<ul>
<li>欄位：
<ul>
<li><code>date</code>：該預測所對應的時間點。<br>
</li>
<li><code>model</code>：模型名稱字串。<br>
</li>
<li><code>y</code>：真實值。<br>
</li>
<li><code>yhat</code>：預測值。<br>
</li>
</ul></li>
</ul></li>
<li><code>rbind(...)</code>：把兩列合併成一個表。<br>
</li>
<li>將這個兩列的小表 append 到 <code>collect_ml</code> 的最後。</li>
</ul></li>
<li><p>更新進度條與關閉：</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(pb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>setTxtProgressBar(pb, i)</code>：把進度條更新到目前第 <code>i</code> 輪。<br>
</li>
<li><code>close(pb)</code>：所有 Rolling 跑完後，關閉進度條物件。</li>
</ul></li>
</ol>
</section>
<section id="彙整所有-rolling-結果並計算誤差指標-1" class="level2">
<h2 class="anchored" data-anchor-id="彙整所有-rolling-結果並計算誤差指標-1">3.6. 彙整所有 Rolling 結果並計算誤差指標</h2>
<p>這一節把所有 Rolling 結果合併成一張表，刪除 NA 預測，再計算各模型的 RMSE、MAE、MAD。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 彙整結果 ----</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>roll_ml <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(collect_ml, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>roll_ml <span class="ot">&lt;-</span> roll_ml[<span class="sc">!</span><span class="fu">is.na</span>(yhat)]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">計算指標...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>score_ml <span class="ot">&lt;-</span> roll_ml[, .(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">rmse</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">mae</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAD  =</span> <span class="fu">madm</span>(y <span class="sc">-</span> yhat)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(model)]</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score_ml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><p><code>roll_ml &lt;- rbindlist(collect_ml, fill=TRUE)</code></p>
<ul>
<li><code>rbindlist()</code>：<code>data.table</code> 提供的函數，把 list 裡的多個 <code>data.table</code> 依列合併。<br>
</li>
<li><code>fill=TRUE</code>：若欄位不完全一致會自動補 <code>NA</code>。<br>
</li>
<li>執行結果：<code>roll_ml</code> 是一張長格式的表，每列是一個時間點 + 一個模型的預測結果。</li>
</ul></li>
<li><p><code>roll_ml &lt;- roll_ml[!is.na(yhat)]</code></p>
<ul>
<li><code>is.na(yhat)</code>：檢查預測值是否為 NA。<br>
</li>
<li><code>!is.na(yhat)</code>：只選出有有效預測值的列。<br>
</li>
<li><code>roll_ml[條件]</code>：<code>data.table</code> 篩選語法。<br>
</li>
<li>執行結果：去除模型失敗（NA）的觀測，避免干擾指標計算。</li>
</ul></li>
<li><p><code>cat("\n計算指標...\n")</code></p>
<ul>
<li>印出提示訊息，表示接下來會計算 RMSE / MAE / MAD。</li>
</ul></li>
<li><p><code>score_ml &lt;- roll_ml[, .( ... ), by=.(model)]</code></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>score_ml <span class="ot">&lt;-</span> roll_ml[, .(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">rmse</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAE  =</span> <span class="fu">mae</span>(y <span class="sc">-</span> yhat),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">MAD  =</span> <span class="fu">madm</span>(y <span class="sc">-</span> yhat)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(model)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>by=.(model)</code>：依模型名稱分組，對 BaggingTree 和 RandomForest 分別算指標。<br>
</li>
<li><code>y - yhat</code>：每列的預測誤差。<br>
</li>
<li>呼叫前面定義的 <code>rmse()</code>、<code>mae()</code>、<code>madm()</code>，分別得到三個評估指標。<br>
</li>
<li>執行結果：<code>score_ml</code> 是一張摘要表，每列對應一種模型，欄位是 RMSE / MAE / MAD。</li>
</ul></li>
<li><p><code>print(score_ml)</code></p>
<ul>
<li>將結果印出來，方便直接在 console 檢查哪個模型表現比較好。</li>
</ul></li>
</ol>
</section>
<section id="儲存結果到-.rds-檔" class="level2">
<h2 class="anchored" data-anchor-id="儲存結果到-.rds-檔">3.7. 儲存結果到 .rds 檔</h2>
<p>最後把 Rolling 的預測結果與指標一起存成一個 <code>.rds</code> 檔，並告知儲存位置。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- 儲存結果 ----</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">儲存結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">list</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">roll_ml =</span> roll_ml,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">score_ml =</span> score_ml</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>), <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ml.rds"</span>))</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"機器學習模型完成！結果已儲存至 %s</span><span class="sc">\n</span><span class="st">"</span>, </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ml.rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li><code>cat("\n儲存結果...\n")</code>
<ul>
<li>印出提示訊息，表示正在把結果寫入檔案。</li>
</ul></li>
<li><code>saveRDS(list(...), file.path(results_dir, "roll_ml.rds"))</code>
<ul>
<li><code>list(roll_ml = roll_ml, score_ml = score_ml)</code>：把預測結果表與指標表打包成一個 list。<br>
</li>
<li><code>saveRDS()</code>：將這個 list 存成 <code>.rds</code> 檔。<br>
</li>
<li><code>file.path(results_dir, "roll_ml.rds")</code>：組出儲存路徑。<br>
</li>
<li>執行結果：在 <code>results_dir</code> 資料夾內產生 <code>roll_ml.rds</code> 檔，之後可以用 <code>readRDS()</code> 讀回。</li>
</ul></li>
<li><code>cat(sprintf("機器學習模型完成！結果已儲存至 %s\n", ...))</code>
<ul>
<li><code>sprintf()</code>：把實際路徑代入 <code>%s</code>。<br>
</li>
<li><code>cat()</code>：印出完整訊息。<br>
</li>
<li>執行結果：console 顯示「機器學習模型完成！」及儲存路徑，方便確認檔案位置。</li>
</ul></li>
</ol>
</section>
</section>
<section id="combine_results.r---合併所有模型結果並輸出" class="level1">
<h1>4_combine_results.R - 合併所有模型結果並輸出</h1>
<p>這份腳本的功能是<strong>整合所有模型（時間序列、Lasso、機器學習）預測結果</strong>，計算指標、排序，最後輸出到 Excel。<br>
通常是整個預測流程的最後一步。</p>
<hr>
<section id="套件載入-1" class="level2">
<h2 class="anchored" data-anchor-id="套件載入-1">4.1. 套件載入</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(writexl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>data.table</code>：用於高效合併與整理模型輸出結果。<br>
</li>
<li><code>writexl</code>：將結果輸出成 <code>.xlsx</code> Excel 檔案。</li>
</ul>
<hr>
</section>
<section id="載入所有結果" class="level2">
<h2 class="anchored" data-anchor-id="載入所有結果">4.2. 載入所有結果</h2>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"載入模型結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"使用 h = %d 的資料</span><span class="sc">\n</span><span class="st">"</span>, h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>檢查是否設定預測步長 <code>h</code>。<br>
</li>
<li>根據 <code>h</code> 找出對應的結果資料夾，例如 <code>outputs/h_3/results/</code>。<br>
</li>
<li>從 <code>prepared_data.rds</code> 重新載入主要設定。</li>
</ol>
<hr>
</section>
<section id="檔案檢查與讀取" class="level2">
<h2 class="anchored" data-anchor-id="檔案檢查與讀取">4.3. 檔案檢查與讀取</h2>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>result_files <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ts.rds"</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(results_dir, <span class="st">"roll_lasso.rds"</span>),</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(results_dir, <span class="st">"roll_ml.rds"</span>)</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>existing_files <span class="ot">&lt;-</span> result_files[<span class="fu">file.exists</span>(result_files)]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(existing_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"沒有找到任何模型結果檔案！請先執行 1_models_ts.R, 2_models_lasso.R, 或 3_models_ml.R"</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"找到以下結果檔案:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(existing_files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>預期會有三份 <code>.rds</code> 模型結果：
<ul>
<li><code>roll_ts.rds</code>：時間序列模型<br>
</li>
<li><code>roll_lasso.rds</code>：Lasso 家族<br>
</li>
<li><code>roll_ml.rds</code>：機器學習模型<br>
</li>
</ul></li>
<li>若三者皆不存在則報錯，提醒先執行前面的模型腳本。</li>
</ul>
<hr>
</section>
<section id="載入與整合結果" class="level2">
<h2 class="anchored" data-anchor-id="載入與整合結果">4.4. 載入與整合結果</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>all_rolls <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>all_scores <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_ts.rds"</span>) <span class="sc">%in%</span> existing_files){</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  res_ts <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_ts.rds"</span>))</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  all_rolls<span class="sc">$</span>roll_ts <span class="ot">&lt;-</span> res_ts<span class="sc">$</span>roll_ts</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  all_scores<span class="sc">$</span>score_ts <span class="ot">&lt;-</span> res_ts<span class="sc">$</span>score_ts</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ 時間序列模型</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_lasso.rds"</span>) <span class="sc">%in%</span> existing_files){</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  res_lasso <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_lasso.rds"</span>))</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  all_rolls<span class="sc">$</span>roll_lasso <span class="ot">&lt;-</span> res_lasso<span class="sc">$</span>roll_lasso</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  all_scores<span class="sc">$</span>score_lasso <span class="ot">&lt;-</span> res_lasso<span class="sc">$</span>score_lasso</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Lasso 家族模型</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_ml.rds"</span>) <span class="sc">%in%</span> existing_files){</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  res_ml <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"roll_ml.rds"</span>))</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  all_rolls<span class="sc">$</span>roll_ml <span class="ot">&lt;-</span> res_ml<span class="sc">$</span>roll_ml</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  all_scores<span class="sc">$</span>score_ml <span class="ot">&lt;-</span> res_ml<span class="sc">$</span>score_ml</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ 機器學習模型</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>若檔案存在，就分別將 <code>roll_*</code>（逐期預測結果）與 <code>score_*</code>（模型誤差指標）載入並存入清單中。<br>
</li>
<li>使用 <code>✓</code> 標示成功載入的模型。</li>
</ul>
<hr>
</section>
<section id="合併所有預測與評分結果" class="level2">
<h2 class="anchored" data-anchor-id="合併所有預測與評分結果">4.5. 合併所有預測與評分結果</h2>
<div class="sourceCode" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">合併所有預測結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(all_rolls, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> metrics[<span class="sc">!</span><span class="fu">is.na</span>(yhat)]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"合併所有評分...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>score <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(all_scores, <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(score, RMSE)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ol type="1">
<li>用 <code>rbindlist()</code> 合併所有模型的逐期預測資料。<br>
</li>
<li>移除 <code>yhat</code> 為 NA 的觀測值。<br>
</li>
<li>把所有模型的 RMSE、MAE、MAD 合併成一張表。<br>
</li>
<li><code>setorder(score, RMSE)</code> 會自動按 RMSE 由小到大排序。</li>
</ol>
<hr>
</section>
<section id="輸出結果到-excel" class="level2">
<h2 class="anchored" data-anchor-id="輸出結果到-excel">4.6. 輸出結果到 Excel</h2>
<div class="sourceCode" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">輸出結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>excel_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"excel_files"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(excel_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>today <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>filename_base <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"h%d_%s"</span>, h, today)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>建立新資料夾 <code>excel_files</code> 儲存輸出結果。<br>
</li>
<li>檔名中加入 <code>h</code> 值與日期，例如 <code>h3_20251104.xlsx</code>。</li>
</ul>
<hr>
</section>
<section id="寫出多個-excel-檔案" class="level2">
<h2 class="anchored" data-anchor-id="寫出多個-excel-檔案">4.7. 寫出多個 Excel 檔案</h2>
<div class="sourceCode" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(score, </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">path =</span> <span class="fu">file.path</span>(excel_dir, </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">sprintf</span>(<span class="st">"model_metrics_%s.xlsx"</span>, filename_base)))</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(metrics, </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">path =</span> <span class="fu">file.path</span>(excel_dir, </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">sprintf</span>(<span class="st">"oos_predictions_%s.xlsx"</span>, filename_base)))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 合併兩個 Sheet</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_metrics_rmse_mae_mad =</span> score,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">oos_predictions_by_model   =</span> metrics</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">file.path</span>(excel_dir, <span class="fu">sprintf</span>(<span class="st">"forecast_outputs_%s.xlsx"</span>, filename_base))</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>產出三個 Excel 檔案：
<ol type="1">
<li><code>model_metrics_*.xlsx</code>：各模型 RMSE / MAE / MAD。<br>
</li>
<li><code>oos_predictions_*.xlsx</code>：每期預測值。<br>
</li>
<li><code>forecast_outputs_*.xlsx</code>：整合版，含兩個 Sheet。</li>
</ol></li>
</ul>
<hr>
</section>
<section id="完成訊息" class="level2">
<h2 class="anchored" data-anchor-id="完成訊息">4.8. 完成訊息</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">結果已輸出至:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s</span><span class="sc">\n</span><span class="st">"</span>, excel_dir))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - forecast_outputs_%s.xlsx</span><span class="sc">\n</span><span class="st">"</span>, filename_base))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - model_metrics_%s.xlsx</span><span class="sc">\n</span><span class="st">"</span>, filename_base))</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - oos_predictions_%s.xlsx</span><span class="sc">\n</span><span class="st">"</span>, filename_base))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">完成！</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>最後輸出訊息清楚列出檔案位置。<br>
</li>
<li>完整標記「完成！」表示整個流程順利結束。</li>
</ul>
<hr>
</section>
<section id="小結-1" class="level2">
<h2 class="anchored" data-anchor-id="小結-1">4.小結</h2>
<p>這支 <code>4_combine_results.R</code>：</p>
<ol type="1">
<li>自動整合前面各模型輸出的 <code>.rds</code> 結果。<br>
</li>
<li>彙總模型表現並排序。<br>
</li>
<li>以多種格式（單表、多 Sheet）輸出 Excel。<br>
</li>
<li>是整個預測流程的最終整理步驟，方便進行結果比較與報告撰寫。</li>
</ol>
</section>
</section>
<section id="nowcast.r---未來多期預測nowcast" class="level1">
<h1>5_nowcast.R - 未來多期預測（Nowcast）</h1>
<p>這份腳本負責在完成所有模型訓練後，<strong>以最後的資料段進行未來多期（如 12 個月）預測</strong>。<br>
它結合時間序列模型、Lasso 家族模型與機器學習模型，最終將 YoY（年增率）預測還原為實際稅收金額並輸出 Excel。</p>
<hr>
<section id="套件載入-2" class="level2">
<h2 class="anchored" data-anchor-id="套件載入-2">5.1. 套件載入</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipred)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(writexl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>data.table</code>：高效資料操作與表格合併。<br>
</li>
<li><code>lubridate</code>：處理日期運算，例如 <code>%m+% months()</code>。<br>
</li>
<li><code>forecast</code>：自動建構 ARIMA / ARMA 時間序列模型。<br>
</li>
<li><code>glmnet</code>：提供 Lasso、Ridge、Elastic Net 等懲罰化迴歸。<br>
</li>
<li><code>ipred</code>：Bagging（自助抽樣集成）模型。<br>
</li>
<li><code>ranger</code>：高效能的 Random Forest 實作。<br>
</li>
<li><code>writexl</code>：將預測結果輸出至 Excel。</li>
</ul>
<hr>
</section>
<section id="載入資料與設定-1" class="level2">
<h2 class="anchored" data-anchor-id="載入資料與設定-1">5.2. 載入資料與設定</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"載入資料...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> setup<span class="sc">$</span>dat</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>target_col_original <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col_original</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>time_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>time_col</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>lag_vars <span class="ot">&lt;-</span> setup<span class="sc">$</span>lag_vars</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>train_len <span class="ot">&lt;-</span> setup<span class="sc">$</span>train_len</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>var_exp_cut <span class="ot">&lt;-</span> setup<span class="sc">$</span>var_exp_cut</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>elastic_alpha <span class="ot">&lt;-</span> setup<span class="sc">$</span>elastic_alpha</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>adapt_gamma <span class="ot">&lt;-</span> setup<span class="sc">$</span>adapt_gamma</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> setup<span class="sc">$</span>output_root</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"使用 h = %d 的資料</span><span class="sc">\n</span><span class="st">"</span>, h))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>prepared_data.rds</code> 由前置腳本生成，內含資料與參數。<br>
</li>
<li>檢查 <code>h</code> 是否設定（代表預測步長）。<br>
</li>
<li>讀入 <code>lag_vars</code>、<code>elastic_alpha</code>、<code>adapt_gamma</code> 等建模必要設定。</li>
</ul>
<hr>
</section>
<section id="預測設定與-glmnet-參數" class="level2">
<h2 class="anchored" data-anchor-id="預測設定與-glmnet-參數">5.3. 預測設定與 glmnet 參數</h2>
<div class="sourceCode" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>H_out <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>glmnet_common <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">standardize=</span><span class="cn">TRUE</span>, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">maxit=</span><span class="fl">1e6</span>, </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">nlambda=</span><span class="dv">80</span>, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda.min.ratio=</span><span class="fl">1e-3</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>H_out</code>：一次要預測的未來期數（例如 12 個月）。<br>
</li>
<li><code>glmnet_common</code>：多種 Lasso/Ridge 模型共用參數設定。</li>
</ul>
<hr>
</section>
<section id="準備最後一個訓練窗" class="level2">
<h2 class="anchored" data-anchor-id="準備最後一個訓練窗">5.4. 準備最後一個訓練窗</h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">準備最後一個訓練窗...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>last_time <span class="ot">&lt;-</span> <span class="fu">max</span>(dat[[time_col]])</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>end_idx   <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>start_idx <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, end_idx <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>final_tr  <span class="ot">&lt;-</span> dat[start_idx<span class="sc">:</span>end_idx]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>使用最後 <code>train_len</code> 筆資料作為最終訓練樣本。<br>
</li>
<li>這樣能利用最新資訊生成未來預測。</li>
</ul>
<hr>
</section>
<section id="建立訓練資料與預測基準" class="level2">
<h2 class="anchored" data-anchor-id="建立訓練資料與預測基準">5.5. 建立訓練資料與預測基準</h2>
<div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>y_all   <span class="ot">&lt;-</span> final_tr[[target_col]]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>X_all   <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(final_tr[, ..lag_vars])</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>good    <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(X_all)) <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>X_all   <span class="ot">&lt;-</span> X_all[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>last_row <span class="ot">&lt;-</span> <span class="fu">tail</span>(dat, <span class="dv">1</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>x_origin <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(last_row[, ..lag_vars])[, good, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>future_dates <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>H_out, <span class="cf">function</span>(hh) last_time <span class="sc">%m+%</span> <span class="fu">months</span>(hh))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>X_all</code>：特徵矩陣，移除含 NA 欄位。<br>
</li>
<li><code>x_origin</code>：最後一期可用特徵，作為未來預測的輸入。<br>
</li>
<li><code>future_dates</code>：自動生成未來 12 個月的日期。</li>
</ul>
<hr>
</section>
<section id="a-時間序列模型預測" class="level2">
<h2 class="anchored" data-anchor-id="a-時間序列模型預測">5.6. (A) 時間序列模型預測</h2>
<div class="sourceCode" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">時間序列模型預測...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>next_rw_path <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">tail</span>(y_all,<span class="dv">1</span>), H_out)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>fit_ar_all <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y_all, <span class="at">d=</span><span class="dv">0</span>, <span class="at">max.q=</span><span class="dv">0</span>, <span class="at">seasonal=</span><span class="cn">FALSE</span>), </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>next_ar_path <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(forecast<span class="sc">::</span><span class="fu">forecast</span>(fit_ar_all, <span class="at">h=</span>H_out)<span class="sc">$</span>mean), </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) next_rw_path</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>fit_arma_all <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y_all, <span class="at">d=</span><span class="dv">0</span>, <span class="at">seasonal=</span><span class="cn">FALSE</span>), </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>next_arma_path <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>(forecast<span class="sc">::</span><span class="fu">forecast</span>(fit_arma_all, <span class="at">h=</span>H_out)<span class="sc">$</span>mean), </span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e) next_rw_path</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><strong>Random Walk</strong>：使用最後一期值重複預測未來。<br>
</li>
<li><strong>AR/ARMA</strong>：利用 <code>auto.arima()</code> 自動尋找最適模型。<br>
</li>
<li>若模型失敗，回退至 Random Walk。</li>
</ul>
<hr>
</section>
<section id="b-lasso-家族與-pcrdirect-strategy" class="level2">
<h2 class="anchored" data-anchor-id="b-lasso-家族與-pcrdirect-strategy">5.7. (B) Lasso 家族與 PCR（Direct Strategy）</h2>
<div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Lasso 家族模型預測...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>train_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>H_out, <span class="cf">function</span>(hh){</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  y_h  <span class="ot">&lt;-</span> <span class="fu">shift</span>(y_all, <span class="at">type=</span><span class="st">"lead"</span>, <span class="at">n=</span>hh)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  keep <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">is.na</span>(y_h)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> y_h[keep], <span class="at">X =</span> X_all[keep,, <span class="at">drop=</span><span class="cn">FALSE</span>], <span class="at">h =</span> hh)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>對每個未來期數 <code>hh</code>（例如 1~12 個月）建一組訓練資料。<br>
</li>
<li><code>shift(..., type="lead")</code>：將目標往前移動，用於 direct forecasting。</li>
</ul>
<p>主要模型包括：</p>
<ol type="1">
<li>Lasso（α=1）<br>
</li>
<li>Ridge（α=0）<br>
</li>
<li>Elastic Net（介於 0 與 1）<br>
</li>
<li>Adaptive Lasso / Elastic Net（加權懲罰）<br>
</li>
<li>PCR（主成分迴歸，根據累積變異比例挑取主成分）</li>
</ol>
<hr>
</section>
<section id="c-非線性模型bagging-tree-與-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="c-非線性模型bagging-tree-與-random-forest">5.8. (C) 非線性模型：Bagging Tree 與 Random Forest</h2>
<div class="sourceCode" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">機器學習模型預測...</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>以相同 direct strategy 訓練 <code>H_out</code> 組模型。<br>
</li>
<li><code>ipred::bagging()</code>：使用多重自助樣本建立 Bagging Tree。<br>
</li>
<li><code>ranger::ranger()</code>：快速建構 Random Forest，預設 500 棵樹。</li>
</ul>
<hr>
</section>
<section id="d-整併所有結果" class="level2">
<h2 class="anchored" data-anchor-id="d-整併所有結果">5.9. (D) 整併所有結果</h2>
<div class="sourceCode" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">整併結果...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>extra_all <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">list</span>(extra_ts, extra_lasso, extra_ml), <span class="at">fill=</span><span class="cn">TRUE</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setorderv</span>(extra_all, <span class="fu">c</span>(<span class="st">"horizon"</span>,<span class="st">"model"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>合併三類模型預測成統一表格。<br>
</li>
<li>按「預測期數」與「模型名稱」排序。</li>
</ul>
<hr>
</section>
<section id="e-將-yoy-預測轉回實際稅收值" class="level2">
<h2 class="anchored" data-anchor-id="e-將-yoy-預測轉回實際稅收值">5.10. (E) 將 YoY 預測轉回實際稅收值</h2>
<div class="sourceCode" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"將 YoY 預測轉回實際稅收值...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>last_12_original <span class="ot">&lt;-</span> <span class="fu">tail</span>(dat[[target_col_original]], <span class="dv">12</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>extra_all[, actual_forecast <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  yoy_pred <span class="ot">&lt;-</span> yhat</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  lag12_index <span class="ot">&lt;-</span> ((horizon <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%%</span> <span class="dv">12</span>) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  base_value <span class="ot">&lt;-</span> last_12_original[lag12_index]</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>  base_value <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> yoy_pred)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>假設模型預測的是「年增率」，需乘上去年同期實際值。<br>
</li>
<li><code>((horizon - 1) %% 12)</code>：確保對應正確月份。<br>
</li>
<li>最終生成 <code>actual_forecast</code> 欄位，表示實際稅收預測。</li>
</ul>
<hr>
</section>
<section id="f-輸出結果" class="level2">
<h2 class="anchored" data-anchor-id="f-輸出結果">5.11. (F) 輸出結果</h2>
<div class="sourceCode" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>excel_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_root, <span class="st">"excel_files"</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(excel_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>today <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>filename <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"nowcast_H%d_h%d_%s.xlsx"</span>, H_out, h, today)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  extra_all[, .(date, horizon, model, </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">yhat_yoy =</span> yhat,</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>                base_value_t12,</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>                actual_forecast)],</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">file.path</span>(excel_dir, filename)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>結果輸出至 <code>excel_files</code> 目錄。<br>
</li>
<li>檔名包含 H_out（預測期數）與 h（模型步長）。<br>
</li>
<li>Excel 內含每個模型的 YoY 與實際預測值。</li>
</ul>
<hr>
</section>
<section id="結束訊息" class="level2">
<h2 class="anchored" data-anchor-id="結束訊息">5.12. 結束訊息</h2>
<div class="sourceCode" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">已輸出包含實際稅收預測值的檔案:</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">file.path</span>(excel_dir, filename)))</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Nowcast 完成！</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>輸出最終預測檔案位置。<br>
</li>
<li>「Nowcast 完成！」表示整個多期預測流程結束。</li>
</ul>
<hr>
</section>
<section id="小結-2" class="level2">
<h2 class="anchored" data-anchor-id="小結-2">5.小結</h2>
<p><code>5_nowcast.R</code> 的流程如下：</p>
<ol type="1">
<li>讀入資料與參數設定。<br>
</li>
<li>以最後訓練窗訓練各類模型。<br>
</li>
<li>對未來 <code>H_out</code> 期進行多期預測。<br>
</li>
<li>將 YoY 還原為實際稅收值。<br>
</li>
<li>匯出完整 Excel 檔案供後續報表或視覺化使用。</li>
</ol>
</section>
</section>
<section id="variable_importance.r---計算變數重要性" class="level1">
<h1>6_variable_importance.R - 計算變數重要性</h1>
<p>這份腳本負責計算各模型的<strong>變數重要性 (Variable Importance)</strong>，包含 Lasso、Ridge、Elastic Net、Adaptive 版本、PCR，以及 Bagging Tree 和 Random Forest。<br>
最終輸出兩層結果：</p>
<ol type="1">
<li><strong>LAG 層級</strong>（每個滯後變數單獨排名）<br>
</li>
<li><strong>BASE 層級</strong>（同一變數不同 lag 的重要性彙總）</li>
</ol>
<hr>
<section id="套件載入與資料準備" class="level2">
<h2 class="anchored" data-anchor-id="套件載入與資料準備">6.1. 套件載入與資料準備</h2>
<div class="sourceCode" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(writexl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>glmnet</code>：提供線性懲罰模型（Lasso、Ridge、EN）。<br>
</li>
<li><code>ranger</code>：用於計算樹模型的 permutation importance。<br>
</li>
<li><code>data.table</code>：高效資料操作。<br>
</li>
<li><code>writexl</code>：將結果輸出為 Excel。</li>
</ul>
<hr>
</section>
<section id="讀取訓練資料與設定" class="level2">
<h2 class="anchored" data-anchor-id="讀取訓練資料與設定">6.2. 讀取訓練資料與設定</h2>
<div class="sourceCode" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(results_dir)) <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"找不到"</span>, results_dir, <span class="st">"，請先跑對應的 0_setup.R。"</span>))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> setup<span class="sc">$</span>dat</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>target_col <span class="ot">&lt;-</span> setup<span class="sc">$</span>target_col</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>lag_vars <span class="ot">&lt;-</span> setup<span class="sc">$</span>lag_vars</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>train_len <span class="ot">&lt;-</span> setup<span class="sc">$</span>train_len</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>載入由前置腳本建立的 <code>prepared_data.rds</code>。<br>
</li>
<li>檢查 <code>h</code>（預測步長）及對應資料夾是否存在。<br>
</li>
<li>取得訓練集設定與特徵欄位名稱。</li>
</ul>
<hr>
</section>
<section id="參數與輔助函數" class="level2">
<h2 class="anchored" data-anchor-id="參數與輔助函數">6.3. 參數與輔助函數</h2>
<div class="sourceCode" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>k_top <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>agg_method <span class="ot">&lt;-</span> <span class="st">"sum"</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>topk_names <span class="ot">&lt;-</span> <span class="cf">function</span>(imp_vec, <span class="at">k =</span> k_top){</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  imp_vec <span class="ot">&lt;-</span> imp_vec[<span class="fu">is.finite</span>(imp_vec)]</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">order</span>(imp_vec, <span class="at">decreasing=</span><span class="cn">TRUE</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  picks <span class="ot">&lt;-</span> <span class="fu">names</span>(imp_vec)[ord][<span class="fu">seq_len</span>(<span class="fu">min</span>(k, <span class="fu">length</span>(ord)))]</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_character_</span>, k)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  out[<span class="fu">seq_along</span>(picks)] <span class="ot">&lt;-</span> picks</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li><code>k_top</code>：每個模型取前 8 名重要變數。<br>
</li>
<li><code>agg_method</code>：當多個 lag 彙總時的方式，可選 <code>"sum"</code> 或 <code>"max"</code>。<br>
</li>
<li><code>topk_names()</code>：回傳重要性向量的前 k 名變數名稱。</li>
</ul>
<hr>
</section>
<section id="建立訓練資料direct-strategy" class="level2">
<h2 class="anchored" data-anchor-id="建立訓練資料direct-strategy">6.4. 建立訓練資料（Direct Strategy）</h2>
<div class="sourceCode" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>end_idx   <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>start_idx <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">1</span>, end_idx <span class="sc">-</span> train_len <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>final_tr  <span class="ot">&lt;-</span> dat[start_idx<span class="sc">:</span>end_idx]</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>y_all <span class="ot">&lt;-</span> final_tr[[target_col]]</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>X_all <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(final_tr[, ..lag_vars])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>使用最後一個 rolling window 的資料。<br>
</li>
<li>準備 <code>(X_t, y_{t+h})</code> 配對作為 direct forecasting 的訓練資料。<br>
</li>
<li>過濾掉含 NA 或近零變異的特徵。</li>
</ul>
<hr>
</section>
<section id="a-lasso-家族重要性以-β-為準" class="level2">
<h2 class="anchored" data-anchor-id="a-lasso-家族重要性以-β-為準">6.5. (A) Lasso 家族重要性（以 |β| 為準）</h2>
<div class="sourceCode" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fit_lasso <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(X_tr2, y_tr2, <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>imp_lasso <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">as.numeric</span>(<span class="fu">coef</span>(fit_lasso, <span class="at">s=</span><span class="st">"lambda.1se"</span>))[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(imp_lasso) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(X_tr2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>各模型的重要性皆取迴歸係數的絕對值。<br>
</li>
<li><strong>Ridge</strong>、<strong>Elastic Net</strong>、<strong>Adaptive 版本</strong>依序同理。<br>
</li>
<li>Adaptive 權重由 Ridge 初估係數反比設定。</li>
</ul>
<p>結果物件： - <code>imp_lasso</code>, <code>imp_ridge</code>, <code>imp_en</code>, <code>imp_ada_lasso</code>, <code>imp_ada_en</code><br>
→ 皆為命名數值向量（名稱 = 特徵名稱，值 = |β|）。</p>
<hr>
</section>
<section id="b-pcr-重要性loading-β-加權和" class="level2">
<h2 class="anchored" data-anchor-id="b-pcr-重要性loading-β-加權和">6.6. (B) PCR 重要性（loading × β 加權和）</h2>
<div class="sourceCode" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(X_tr2, <span class="at">center=</span><span class="cn">TRUE</span>, <span class="at">scale.=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>var_exp <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="fu">sum</span>(pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>k_pc <span class="ot">&lt;-</span> <span class="fu">which</span>(var_exp <span class="sc">&gt;=</span> var_exp_cut)[<span class="dv">1</span>]</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>Z_tr <span class="ot">&lt;-</span> pca<span class="sc">$</span>x[,<span class="dv">1</span><span class="sc">:</span>k_pc, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>fit_pcr <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_tr2 <span class="sc">~</span> Z_tr)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit_pcr)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>rot  <span class="ot">&lt;-</span> pca<span class="sc">$</span>rotation[,<span class="dv">1</span><span class="sc">:</span>k_pc, drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>imp_pcr <span class="ot">&lt;-</span> <span class="fu">abs</span>(rot <span class="sc">%*%</span> <span class="fu">abs</span>(beta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>取前 <code>k_pc</code> 個可解釋 <code>var_exp_cut</code> 比例變異的主成分。<br>
</li>
<li>每個原始變數的重要性由各主成分載荷（loading）與回歸係數加權計算。</li>
</ul>
<hr>
</section>
<section id="c-樹模型重要性" class="level2">
<h2 class="anchored" data-anchor-id="c-樹模型重要性">6.7. (C) 樹模型重要性</h2>
<div class="sourceCode" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>fit_rf_imp <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y_tr2, <span class="at">x =</span> <span class="fu">data.frame</span>(X_tr2),</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> <span class="dv">500</span>,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(p)),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="st">"permutation"</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>imp_rf <span class="ot">&lt;-</span> fit_rf_imp<span class="sc">$</span>variable.importance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>Bagging Tree 的重要性用 Random Forest (<code>mtry=p</code>) 的 permutation importance 近似。<br>
</li>
<li>Random Forest 使用經典 <code>mtry=sqrt(p)</code> 設定。<br>
</li>
<li><code>importance = "permutation"</code>：以模型預測誤差增幅衡量變數貢獻。</li>
</ul>
<hr>
</section>
<section id="d-lag-層級排名表" class="level2">
<h2 class="anchored" data-anchor-id="d-lag-層級排名表">6.8. (D) LAG 層級排名表</h2>
<div class="sourceCode" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>imp_list_lag <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"LASSO"</span> <span class="ot">=</span> imp_lasso,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EN"</span> <span class="ot">=</span> imp_en,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adaptive LASSO"</span> <span class="ot">=</span> imp_ada_lasso,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Adaptive EN"</span> <span class="ot">=</span> imp_ada_en,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ridge"</span> <span class="ot">=</span> imp_ridge,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCR"</span> <span class="ot">=</span> imp_pcr,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Bagging (proxy)"</span> <span class="ot">=</span> imp_bag,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Random Forest"</span> <span class="ot">=</span> imp_rf</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>將所有模型的重要性集合為清單。<br>
</li>
<li>使用 <code>topk_names()</code> 取得每個模型前 <code>k_top</code> 名變數。<br>
</li>
<li>結果輸出三個版本：
<ul>
<li><code>LAG_top_CODE</code>：原始代碼名<br>
</li>
<li><code>LAG_top_SHORT</code>：對應簡稱（含資料集前綴）<br>
</li>
<li><code>LAG_top_LONG</code>：完整中文名稱</li>
</ul></li>
</ul>
<hr>
</section>
<section id="e-名稱對照表映射" class="level2">
<h2 class="anchored" data-anchor-id="e-名稱對照表映射">6.9. (E) 名稱對照表映射</h2>
<div class="sourceCode" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>map_raw <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(readxl<span class="sc">::</span><span class="fu">read_excel</span>(map_path, <span class="at">sheet =</span> map_sheet))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>讀入變數代碼對照表（含欄位 <code>var_label</code>, <code>dataset_title</code>, <code>series_name</code>）。<br>
</li>
<li>函數 <code>split_lag()</code>、<code>make_display_names()</code> 將每個變數拆成：
<ul>
<li><code>base</code>（不含 lag 後綴）</li>
<li><code>lag</code>（如 L1, L2…）</li>
</ul></li>
<li>產出短名與長名兩組名稱，用於 Excel 呈現。</li>
</ul>
<hr>
</section>
<section id="f-base-層級彙總" class="level2">
<h2 class="anchored" data-anchor-id="f-base-層級彙總">6.10. (F) BASE 層級彙總</h2>
<div class="sourceCode" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>aggregate_importance <span class="ot">&lt;-</span> <span class="cf">function</span>(imp_vec, <span class="at">method =</span> <span class="fu">c</span>(<span class="st">"sum"</span>,<span class="st">"max"</span>)){</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  nm <span class="ot">&lt;-</span> <span class="fu">names</span>(imp_vec)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"_L</span><span class="sc">\\</span><span class="st">d+$"</span>,<span class="st">""</span>, nm)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  DT <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">base=</span>base, <span class="at">imp=</span>imp_vec)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  agg <span class="ot">&lt;-</span> DT[, .(<span class="at">imp =</span> <span class="cf">if</span> (method<span class="sc">==</span><span class="st">"sum"</span>) <span class="fu">sum</span>(imp) <span class="cf">else</span> <span class="fu">max</span>(imp)), by<span class="ot">=</span>base]</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(agg<span class="sc">$</span>imp, agg<span class="sc">$</span>base)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>同一變數的不同滯後值（例如 GDP_L1, GDP_L2）被彙整回 base 名稱。<br>
</li>
<li>可用總和 (<code>sum</code>) 或最大值 (<code>max</code>) 方式合併。</li>
</ul>
<hr>
</section>
<section id="g-結果輸出" class="level2">
<h2 class="anchored" data-anchor-id="g-結果輸出">6.11. (G) 結果輸出</h2>
<div class="sourceCode" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>excel_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_root, <span class="st">"excel_files"</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>today <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y%m%d"</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>filename_lag  <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"var_importance_LAG_top%d_h%d_%s.xlsx"</span>, k_top, h, today)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>filename_base <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"var_importance_BASE_top%d_h%d_%s_%s.xlsx"</span>, </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                         k_top, h, <span class="fu">toupper</span>(agg_method), today)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>兩份 Excel 輸出：
<ol type="1">
<li><strong>LAG 層級</strong>：各模型對每個滯後變數的前 k 名。<br>
</li>
<li><strong>BASE 層級</strong>：彙總後的前 k 名變數。<br>
</li>
</ol></li>
<li>檔名包含 <code>h</code> 值、日期、彙總方式。</li>
</ul>
<hr>
</section>
<section id="結束訊息與預覽" class="level2">
<h2 class="anchored" data-anchor-id="結束訊息與預覽">6.12. 結束訊息與預覽</h2>
<div class="sourceCode" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">變數重要性分析完成！</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(tbl_lag_short, <span class="dv">3</span>))</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(tbl_base_short, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：</p>
<ul>
<li>Console 會輸出結果路徑與前幾名變數。<br>
</li>
<li>使用者可立即檢視變數排序與名稱對應情況。</li>
</ul>
<hr>
</section>
<section id="小結-3" class="level2">
<h2 class="anchored" data-anchor-id="小結-3">6.小結</h2>
<p><code>6_variable_importance.R</code> 的功能為：</p>
<ol type="1">
<li>計算多模型（Lasso、Ridge、EN、Adaptive、PCR、RF）變數重要性。<br>
</li>
<li>整理成 <strong>LAG</strong> 與 <strong>BASE</strong> 兩層視角。<br>
</li>
<li>自動對應變數名稱（長短版）。<br>
</li>
<li>將結果輸出為可直接報告使用的 Excel 表格。</li>
</ol>
<p>這是整個專案分析流程的最後一個技術模組，用於歸納模型判斷依據與關鍵驅動因子。</p>
</section>
</section>
<section id="visualize.r-視覺化分析" class="level1">
<h1>7_visualize.R — 視覺化分析</h1>
<hr>
<section id="套件載入與輸出結構設定" class="level2">
<h2 class="anchored" data-anchor-id="套件載入與輸出結構設定">7.1. 套件載入與輸出結構設定</h2>
<div class="sourceCode" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>這四個套件對應功能如下：<br>
- <code>data.table</code>：用於高速處理預測與得分資料。<br>
- <code>ggplot2</code>：主力視覺化套件。<br>
- <code>scales</code>：提供軸標與數字格式轉換（例如千分位）。<br>
- <code>readxl</code>：讀取 Excel 檔，因前面整合結果皆為 <code>.xlsx</code> 格式。</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"h"</span>)) <span class="fu">stop</span>(<span class="st">"沒有設定 h，請在外面給 h 再跑這支 script。"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"outputs"</span>, <span class="fu">paste0</span>(<span class="st">"h_"</span>, h), <span class="st">"results"</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(results_dir, <span class="st">"prepared_data.rds"</span>))</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> setup<span class="sc">$</span>h</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>output_root <span class="ot">&lt;-</span> setup<span class="sc">$</span>output_root</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>說明：<br>
1. <code>h</code> 是 horizon（預測期數），必須在外層腳本設定。<br>
2. <code>file.path</code> 確保路徑跨平台正確拼接。<br>
3. <code>readRDS()</code> 讀取前面 <code>0_setup.R</code> 產出的設定資料，確保一致性。<br>
4. 讀取後重新賦值 <code>h &lt;- setup$h</code> 以防外部傳入錯誤。</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>fig_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_root, <span class="st">"figures"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(fig_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>today <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.Date</span>(), <span class="st">"%Y-%m-%d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>建立輸出圖表資料夾。<br>
- <code>recursive=TRUE</code> 允許多層目錄自動建立。<br>
- <code>today</code> 為動態日期，用於檔案命名。</p>
<hr>
</section>
<section id="樣本外預測資料載入與繪圖" class="level2">
<h2 class="anchored" data-anchor-id="樣本外預測資料載入與繪圖">7.2. 樣本外預測資料載入與繪圖</h2>
<div class="sourceCode" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>excel_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_root, <span class="st">"excel_files"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>metrics_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(excel_dir, <span class="at">pattern=</span><span class="st">"^forecast_outputs_.*</span><span class="sc">\\</span><span class="st">.xlsx$"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>自動抓取最新的模型輸出檔。<br>
<code>pattern</code> 使用正則表達式過濾出命名為 <code>forecast_outputs_日期.xlsx</code> 的檔案。</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>latest_metrics <span class="ot">&lt;-</span> metrics_files[<span class="fu">which.max</span>(<span class="fu">file.info</span>(metrics_files)<span class="sc">$</span>mtime)]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>metrics <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">read_excel</span>(latest_metrics, <span class="at">sheet =</span> <span class="st">"oos_predictions_by_model"</span>))</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>score   <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">read_excel</span>(latest_metrics, <span class="at">sheet =</span> <span class="st">"model_metrics_rmse_mae_mad"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>which.max(file.info(...)$mtime)</code> 取出最新修改的檔案。<br>
然後從 Excel 兩個 sheet 載入： - <code>metrics</code> 為逐期預測結果（含 y, yhat）<br>
- <code>score</code> 為模型績效指標（RMSE、MAE、MAD）</p>
<hr>
<section id="圖-1-時間序列模型" class="level3">
<h3 class="anchored" data-anchor-id="圖-1-時間序列模型">7.2.1 圖 1 – 時間序列模型</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>ts_models <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"RandomWalk"</span>, <span class="st">"AR"</span>, <span class="st">"ARMA"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics[model <span class="sc">%in%</span> ts_models], <span class="fu">aes</span>(<span class="at">x=</span>date)) <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>y, <span class="at">color=</span><span class="st">"實際值"</span>), <span class="at">linewidth=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>yhat, <span class="at">color=</span>model), <span class="at">linewidth=</span><span class="fl">0.6</span>, <span class="at">alpha=</span><span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>解釋：<br>
- <code>metrics[model %in% ts_models]</code> 過濾三種模型的資料。<br>
- <code>geom_line</code> 第一層繪實際值（黑線），第二層繪各模型預測線。<br>
- <code>alpha</code> 控制透明度，讓重疊線條仍可辨識。</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"實際值"</span><span class="ot">=</span><span class="st">"black"</span>, <span class="st">"RandomWalk"</span><span class="ot">=</span><span class="st">"#E41A1C"</span>, </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"AR"</span><span class="ot">=</span><span class="st">"#377EB8"</span>, <span class="st">"ARMA"</span><span class="ot">=</span><span class="st">"#4DAF4A"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>手動指定固定顏色，使所有執行批次配色一致。</p>
<p><img src="./outputs/h_6/figures/oos_timeseries_h6_20251103.png" class="img-fluid"></p>
<p><strong>輸出結果說明：</strong><br>
此圖呈現實際 YoY 與三種時間序列預測走勢。<br>
<code>RandomWalk</code> 做為基準線，其餘兩者反映不同的自相關結構。</p>
<hr>
</section>
<section id="圖-2-lasso-家族模型" class="level3">
<h3 class="anchored" data-anchor-id="圖-2-lasso-家族模型">7.2.2 圖 2 – Lasso 家族模型</h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>lasso_models <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Lasso"</span>, <span class="st">"Ridge"</span>, <span class="st">"ElasticNet"</span>, <span class="st">"AdaLasso"</span>, <span class="st">"AdaElasticNet"</span>, <span class="st">"PCR"</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics[model <span class="sc">%in%</span> lasso_models], <span class="fu">aes</span>(<span class="at">x=</span>date)) <span class="sc">+</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>這一段重複上面流程，但針對線性正則化模型群組。<br>
透過 <code>scale_color_manual()</code> 保持配色一致性。</p>
<p><img src="./outputs/h_6/figures/oos_lasso_h6_20251103.png" class="img-fluid"></p>
<p><strong>程式邏輯：</strong> - Lasso、Ridge 透過懲罰項抑制過擬合。<br>
- PCR 先降維再回歸。<br>
- 全部統一繪於一張圖方便比較。</p>
<hr>
</section>
<section id="圖-3-機器學習模型" class="level3">
<h3 class="anchored" data-anchor-id="圖-3-機器學習模型">7.2.3 圖 3 – 機器學習模型</h3>
<div class="sourceCode" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>ml_models <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BaggingTree"</span>, <span class="st">"RandomForest"</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics[model <span class="sc">%in%</span> ml_models], <span class="fu">aes</span>(<span class="at">x=</span>date)) <span class="sc">+</span> ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>同樣繪製實際 vs.&nbsp;預測，但僅包含樹模型。</p>
<p><img src="./outputs/h_6/figures/oos_ml_h6_20251103.png" class="img-fluid"></p>
<p><strong>邏輯重點：</strong> - Bagging: 利用 bootstrap 降低方差。<br>
- Random Forest: 在 Bagging 基礎上隨機化特徵選取，提升泛化能力。</p>
<hr>
</section>
<section id="圖-4-各模型誤差分布" class="level3">
<h3 class="anchored" data-anchor-id="圖-4-各模型誤差分布">7.2.4 圖 4 – 各模型誤差分布</h3>
<div class="sourceCode" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>metrics[, error <span class="sc">:</span><span class="er">=</span> y <span class="sc">-</span> yhat]</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(metrics, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">reorder</span>(model, error, <span class="at">FUN=</span>median), <span class="at">y=</span>error)) <span class="sc">+</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">fill=</span><span class="st">"skyblue"</span>, <span class="at">alpha=</span><span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>新增欄位 <code>error</code> 代表實際與預測差。<br>
</li>
<li><code>reorder()</code> 依誤差中位數排序模型，使圖表可視化中立偏誤方向。</li>
</ul>
<p><img src="./outputs/h_6/figures/error_distribution_h6_20251103.png" class="img-fluid"></p>
<p><strong>邏輯重點：</strong> - 箱型圖集中於零線附近代表模型穩定。<br>
- 若上下鬚極端偏長，代表對部分區間擬合失準。</p>
<hr>
</section>
<section id="圖-5-rmse-模型排名" class="level3">
<h3 class="anchored" data-anchor-id="圖-5-rmse-模型排名">7.2.5 圖 5 – RMSE 模型排名</h3>
<div class="sourceCode" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>score_sorted <span class="ot">&lt;-</span> score[<span class="fu">order</span>(RMSE)]</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(score_sorted, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">reorder</span>(model, <span class="sc">-</span>RMSE), <span class="at">y=</span>RMSE)) <span class="sc">+</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill=</span><span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">sprintf</span>(<span class="st">"%.4f"</span>, RMSE)), <span class="at">hjust=</span><span class="sc">-</span><span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>依 RMSE 從小排至大，顯示誤差大小。<br>
</li>
<li><code>geom_text</code> 直接顯示數值便於比較。</li>
</ul>
<p><img src="./outputs/h_6/figures/model_ranking_h6_20251103.png" class="img-fluid"></p>
<hr>
</section>
</section>
<section id="未來預測-nowcast" class="level2">
<h2 class="anchored" data-anchor-id="未來預測-nowcast">7.3. 未來預測 (Nowcast)</h2>
<section id="資料載入" class="level3">
<h3 class="anchored" data-anchor-id="資料載入">7.3.1 資料載入</h3>
<div class="sourceCode" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>nowcast_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(excel_dir, <span class="at">pattern=</span><span class="st">"^nowcast_.*</span><span class="sc">\\</span><span class="st">.xlsx$"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>latest_nowcast <span class="ot">&lt;-</span> nowcast_files[<span class="fu">which.max</span>(<span class="fu">file.info</span>(nowcast_files)<span class="sc">$</span>mtime)]</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>nowcast <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">read_excel</span>(latest_nowcast))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>自動抓取最新的 nowcast 結果。<br>
資料包含未來日期、horizon、yhat_yoy 與 actual_forecast。</p>
<hr>
</section>
<section id="圖-6-未來-yoy-預測路徑" class="level3">
<h3 class="anchored" data-anchor-id="圖-6-未來-yoy-預測路徑">7.3.2 圖 6 – 未來 YoY 預測路徑</h3>
<div class="sourceCode" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>nowcast_summary <span class="ot">&lt;-</span> nowcast[, .(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">mean</span>(yhat_yoy, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">q25 =</span> <span class="fu">quantile</span>(yhat_yoy, <span class="fl">0.25</span>),</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">q75 =</span> <span class="fu">quantile</span>(yhat_yoy, <span class="fl">0.75</span>),</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min =</span> <span class="fu">min</span>(yhat_yoy), <span class="at">max =</span> <span class="fu">max</span>(yhat_yoy)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>計算每期預測分佈的統計指標。<br>
之後使用 <code>geom_ribbon()</code> 畫不確定區間，<code>geom_line()</code> 畫平均線。</p>
<p><img src="./outputs/h_6/figures/forecast_paths_yoy_h6_20251103.png" class="img-fluid"></p>
<p><strong>經濟意涵：</strong> - 中央深藍帶代表主要模型預測區間。<br>
- 越窄代表模型間一致性越高。</p>
<hr>
</section>
<section id="圖-7-實際稅收預測" class="level3">
<h3 class="anchored" data-anchor-id="圖-7-實際稅收預測">7.3.3 圖 7 – 實際稅收預測</h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>nowcast_actual <span class="ot">&lt;-</span> nowcast[, .(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="fu">mean</span>(actual_forecast),</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">q25 =</span> <span class="fu">quantile</span>(actual_forecast, <span class="fl">0.25</span>),</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">q75 =</span> <span class="fu">quantile</span>(actual_forecast, <span class="fl">0.75</span>),</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">min =</span> <span class="fu">min</span>(actual_forecast), <span class="at">max =</span> <span class="fu">max</span>(actual_forecast)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>date]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>以相同概念繪製實際金額層面，Y 軸加上 <code>scale_y_continuous(labels=comma)</code> 轉千分位格式。</p>
<p><img src="./outputs/h_6/figures/forecast_actual_h6_20251103.png" class="img-fluid"></p>
<hr>
</section>
</section>
<section id="變數重要性分析" class="level2">
<h2 class="anchored" data-anchor-id="變數重要性分析">7.4. 變數重要性分析</h2>
<section id="載入與轉換" class="level3">
<h3 class="anchored" data-anchor-id="載入與轉換">7.4.1 載入與轉換</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>imp_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(excel_dir, <span class="at">pattern=</span><span class="st">"^var_importance_BASE.*</span><span class="sc">\\</span><span class="st">.xlsx$"</span>, <span class="at">full.names=</span><span class="cn">TRUE</span>)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>latest_imp <span class="ot">&lt;-</span> imp_files[<span class="fu">which.max</span>(<span class="fu">file.info</span>(imp_files)<span class="sc">$</span>mtime)]</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>imp_short <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">read_excel</span>(latest_imp, <span class="at">sheet=</span><span class="st">"BASE_top_SHORT"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>讀取最終變數重要性結果，主要為每模型前 8 名。</p>
<hr>
</section>
<section id="圖-8-各模型前五名變數" class="level3">
<h3 class="anchored" data-anchor-id="圖-8-各模型前五名變數">7.4.2 圖 8 – 各模型前五名變數</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>imp_long <span class="ot">&lt;-</span> <span class="fu">melt</span>(imp_short[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], <span class="at">id.vars=</span><span class="st">"排序"</span>, <span class="at">variable.name=</span><span class="st">"model"</span>, <span class="at">value.name=</span><span class="st">"variable"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(imp_long, <span class="fu">aes</span>(<span class="at">x=</span>排序, <span class="at">y=</span><span class="fu">reorder</span>(variable, <span class="sc">-</span>排序), <span class="at">color=</span>model)) <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="at">alpha=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./outputs/h_6/figures/importance_ranking_h6_20251103.png" class="img-fluid"></p>
<p>此圖顯示跨模型的變數共識。<br>
若某變數在多模型都靠前，代表其影響力穩定。</p>
<hr>
</section>
<section id="圖-9-共識熱力圖" class="level3">
<h3 class="anchored" data-anchor-id="圖-9-共識熱力圖">7.4.3 圖 9 – 共識熱力圖</h3>
<p>程式邏輯：</p>
<ol type="1">
<li>取出前五名變數。<br>
</li>
<li>建立空矩陣（列=變數、欄=模型）。<br>
</li>
<li>依各模型名次填入 rank 值。<br>
</li>
<li>將矩陣轉為長格式畫 tile。</li>
</ol>
<div class="sourceCode" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>p9 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(heat_dt, <span class="fu">aes</span>(<span class="at">x=</span>model, <span class="at">y=</span>variable, <span class="at">fill=</span>rank)) <span class="sc">+</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color=</span><span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(rank), rank, <span class="st">""</span>)), <span class="at">color=</span><span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="./outputs/h_6/figures/importance_heatmap_h6_20251103.png" class="img-fluid"></p>
<p><strong>閱讀方式：</strong> - 顏色越亮表示排名越高（重要）。<br>
- 灰色區表示該變數未進入該模型前五。<br>
- 同一行亮度一致者為跨模型關鍵變數。</p>
<hr>
</section>
</section>
<section id="收尾與輸出檢查" class="level2">
<h2 class="anchored" data-anchor-id="收尾與輸出檢查">7.5. 收尾與輸出檢查</h2>
<div class="sourceCode" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>all_plots <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fig_dir, <span class="at">pattern=</span><span class="st">"</span><span class="sc">\\</span><span class="st">.png$"</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(plot <span class="cf">in</span> all_plots){</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  ✓ %s</span><span class="sc">\n</span><span class="st">"</span>, plot))</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>這段是最終檢查：列出所有輸出圖檔，<br>
可在 log 看到生成情況確認沒有錯漏。</p>
<hr>
</section>
<section id="總結" class="level2">
<h2 class="anchored" data-anchor-id="總結">7.總結</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>模組</th>
<th>功能</th>
<th>備註</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Part 1</td>
<td>樣本外預測視覺化</td>
<td>ggplot2 + 自動配色控制</td>
</tr>
<tr class="even">
<td>Part 2</td>
<td>未來預測路徑</td>
<td>ribbon + 分位統計</td>
</tr>
<tr class="odd">
<td>Part 3</td>
<td>變數重要性</td>
<td>melt + tile 熱力圖</td>
</tr>
</tbody>
</table>
<p>整體為全自動生成視覺化報告模組，可直接嵌入 Quarto 流程。<br>
若要擴展，建議： 1. 封裝各圖為函數，方便未來不同 <code>h</code> 值重複呼叫。<br>
2. 增加 <code>theme_set()</code> 控制全域風格。<br>
3. 加入 <code>caption</code> 自動記錄日期與版本資訊。</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>